<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Friend Map Galaxy v2.0</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-color: #0b0c10;
            --text-color: #c5c6c7;
            --highlight: #66fcf1;
            --female: #ff4d94;
            --male: #00d2ff;
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            font-family: 'PingFang SC', 'Helvetica Neue', sans-serif;
            overflow: hidden;
            color: white;
        }

        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        /* å¼€å…³æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--highlight); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* æ‚¬åœå¡ç‰‡ */
        #tooltip {
            position: absolute;
            opacity: 0;
            background: rgba(20, 20, 30, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(102, 252, 241, 0.3);
            padding: 16px;
            border-radius: 12px;
            pointer-events: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            max-width: 260px;
            transform: translate(-50%, -110%);
            transition: opacity 0.2s;
            z-index: 20;
        }
        #tooltip h3 { margin: 0 0 8px 0; color: var(--highlight); font-size: 18px; display: flex; align-items: center; justify-content: space-between; }
        #tooltip .tags { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
        #tooltip .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); color: #ddd; }
        #tooltip .tag.mbti { background: #5c2a9d; color: #fff; }
        #tooltip .story { font-size: 13px; line-height: 1.6; color: #eee; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; margin-top: 8px; }

        /* èƒŒæ™¯æ˜Ÿç©º */
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite ease-in-out; }
        @keyframes twinkle { 0%, 100% { opacity: 0.1; } 50% { opacity: 0.8; } }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¼€å…³ -->
    <div class="controls">
        <span>æ˜¾ç¤ºæœ‹å‹é—´å…³ç³»</span>
        <label class="switch">
            <input type="checkbox" id="toggleRel" checked>
            <span class="slider"></span>
        </label>
    </div>

    <!-- æ‚¬æµ®æ¡† -->
    <div id="tooltip"></div>
    
    <!-- ç”»å¸ƒå®¹å™¨ -->
    <div id="chart-container"></div>

    <script>
        // =========================================================
        // ğŸ› ï¸ PART 1: é…ç½®åŒºåŸŸ (åœ¨æ­¤å¤„ä¿®æ”¹æ•°æ®)
        // =========================================================

        const CONFIG = {
            // 1. æ‰‡åŒºé¡ºåºè®¾ç½®ï¼šä½ æƒ³å±•ç¤ºå“ªäº›æ¥æºï¼ŸæŒ‰ä»€ä¹ˆé¡ºåºæ’ï¼Ÿï¼ˆæ”¯æŒä»»æ„æ•°é‡ï¼‰
            // åªè¦è¿™é‡Œå†™äº†ï¼Œå›¾ä¸Šå°±ä¼šæœ‰è¿™ä¸ªæ‰‡åŒºã€‚
            stageOrder: ["å°å­¦/å‘å°", "åˆä¸­", "é«˜ä¸­", "å¤§å­¦", "ç ”ç©¶ç”Ÿ", "å®ä¹ ", "å…´è¶£ç¤¾ç¾¤", "å…¶ä»–"],
            
            // 2. é¢œè‰²é…ç½®
            colors: {
                female: "#ff4d94", // å¥³ç”Ÿé¢œè‰²
                male: "#00d2ff",   // ç”·ç”Ÿé¢œè‰²
                center: "#ffd700", // "æˆ‘"çš„é¢œè‰²
                text: "#888888"    // æ ‡ç­¾æ–‡å­—é¢œè‰²
            }
        };

        const DATA = {
            // 1. æœ‹å‹åˆ—è¡¨
            friends: [
                // å¿…å¡«ï¼šname(å”¯ä¸€æ ‡è¯†), stage(å¿…é¡»å¯¹åº”ä¸Šæ–¹stageOrder), distance(0-100), gender
                // é€‰å¡«ï¼šcontact(true/false), mbti, character(æ€§æ ¼), story
                { name: "å°A", stage: "ç ”ç©¶ç”Ÿ", distance: 15, contact: true, gender: "å¥³", mbti: "ENFP", character: "å¿«ä¹å°ç‹—", story: "ç ”ä¸€æœ€å´©æºƒçš„æ—¶å€™é™ªæˆ‘é€šå®µæ”¹è®ºæ–‡ã€‚" },
                { name: "è€ç‹", stage: "å®ä¹ ", distance: 40, contact: true, gender: "ç”·", mbti: "INTJ", character: "æ¯’èˆŒ", story: "æˆ‘çš„èŒåœºå¯¼å¸ˆï¼Œæ•™ä¼šæˆ‘å†™ä»£ç ã€‚" },
                { name: "Cå›", stage: "å¤§å­¦", distance: 25, contact: true, gender: "ç”·", mbti: "", character: "ç¨³é‡", story: "å¤§å­¦å››å¹´çš„é¥­æ­å­ã€‚" },
                { name: "åŒæ¡ŒD", stage: "é«˜ä¸­", distance: 30, contact: false, gender: "å¥³", story: "ä»¥å‰ä¸€èµ·é€ƒè¯¾çœ‹æ˜Ÿæ˜Ÿï¼Œç°åœ¨è™½ç„¶ä¸è”ç³»ä½†å¿ƒé‡Œæœ‰å¥¹ã€‚" },
                { name: "ç½‘å‹E", stage: "å…´è¶£ç¤¾ç¾¤", distance: 60, contact: true, gender: "å¥³", mbti: "INFP", story: "åœ¨æ¸¸æˆé‡Œè®¤è¯†çš„ï¼Œæ²¡é¢åŸºè¿‡ä½†å¾ˆèŠå¾—æ¥ã€‚" },
                { name: "å‘å°F", stage: "å°å­¦/å‘å°", distance: 5, contact: true, gender: "å¥³", character: "å®¶äººèˆ¬çš„å­˜åœ¨", story: "è®¤è¯†20å¹´äº†ã€‚" },
                { name: "ç¤¾å›¢G", stage: "å¤§å­¦", distance: 55, contact: false, gender: "ç”·", story: "æ›¾ç»çš„ç¤¾å›¢ç¤¾é•¿ã€‚" },
                { name: "Hæ€»", stage: "å…¶ä»–", distance: 80, contact: true, gender: "ç”·", story: "åæ¥åœ¨ä¸€æ¬¡ä¼šè®®ä¸Šè®¤è¯†çš„å‰è¾ˆã€‚" },
            ],

            // 2. æœ‹å‹é—´çš„å…³ç³» (é¢å¤–è¿çº¿)
            // source/target å¿…é¡»å¡«ä¸Šé¢ friends é‡Œçš„ name
            relationships: [
                { source: "å°A", target: "è€ç‹", type: "couple", label: "æƒ…ä¾£", dashed: false, arrow: false },
                { source: "Cå›", target: "ç¤¾å›¢G", type: "friend", label: "æ­»å…š", dashed: true, arrow: false },
                { source: "è€ç‹", target: "Hæ€»", type: "mentor", label: "å¸ˆå¾’", dashed: true, arrow: true }, // arrow: true è¡¨ç¤ºæœ‰æ–¹å‘çš„ç®­å¤´
            ]
        };

        // =========================================================
        // ğŸ’» PART 2: æ ¸å¿ƒä»£ç é€»è¾‘ (æ— éœ€ä¿®æ”¹)
        // =========================================================

        let svg, width, height, centerX, centerY, maxRadius;

        // åˆå§‹åŒ–
        function init() {
            createStars();
            drawChart();
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', () => {
                drawChart();
            });

            // ç›‘å¬å¼€å…³åˆ‡æ¢
            d3.select("#toggleRel").on("change", function() {
                const isChecked = this.checked;
                d3.selectAll(".rel-group").transition().duration(500).style("opacity", isChecked ? 1 : 0);
            });
        }

        function drawChart() {
            // æ¸…é™¤æ—§å›¾
            d3.select("#chart-container").selectAll("*").remove();

            // è·å–å½“å‰è§†å£å°ºå¯¸
            width = window.innerWidth;
            height = window.innerHeight;
            centerX = width / 2;
            centerY = height / 2;
            
            // å“åº”å¼åŠå¾„è®¡ç®—ï¼šæ‰‹æœºç«¯ç•™ç™½å°‘ä¸€ç‚¹ï¼Œç”µè„‘ç«¯ç•™ç™½å¤šä¸€ç‚¹
            const isMobile = width < 600;
            const margin = isMobile ? 40 : 100;
            maxRadius = Math.min(width, height) / 2 - margin;

            // åˆ›å»ºSVG
            svg = d3.select("#chart-container").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .append("g")
                .attr("transform", `translate(${centerX},${centerY})`);

            // å®šä¹‰ç®­å¤´ Marker
            const defs = svg.append("defs");
            defs.append("marker")
                .attr("id", "arrow-marker")
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 15) // è°ƒæ•´ç®­å¤´ä½ç½®
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-5L10,0L0,5")
                .attr("fill", "rgba(255,255,255,0.5)");

            // å‘å…‰æ»¤é•œ
            const filter = defs.append("filter").attr("id", "glow");
            filter.append("feGaussianBlur").attr("stdDeviation", "2.5").attr("result", "coloredBlur");
            const feMerge = filter.append("feMerge");
            feMerge.append("feMergeNode").attr("in", "coloredBlur");
            feMerge.append("feMergeNode").attr("in", "SourceGraphic");

            // --- 1. æ¯”ä¾‹å°º ---
            const angleScale = d3.scaleBand()
                .domain(CONFIG.stageOrder)
                .range([0, 2 * Math.PI])
                .align(0);

            const radiusScale = d3.scaleLinear()
                .domain([0, 100])
                .range([isMobile ? 30 : 50, maxRadius]); // ç•™å‡ºåœ†å¿ƒç©ºéš™

            const colorScale = (gender) => gender === "å¥³" ? CONFIG.colors.female : CONFIG.colors.male;

            // --- 2. ç»˜åˆ¶æ‰‡åŒºèƒŒæ™¯ & æ ‡ç­¾ ---
            CONFIG.stageOrder.forEach(stage => {
                const angle = angleScale(stage) + angleScale.bandwidth() / 2;
                // è¾…åŠ©çº¿
                const lineStartRadius = isMobile ? 30 : 50;
                const lineX = Math.sin(angleScale(stage)) * maxRadius;
                const lineY = -Math.cos(angleScale(stage)) * maxRadius;
                
                svg.append("line")
                    .attr("x1", 0).attr("y1", 0)
                    .attr("x2", lineX).attr("y2", lineY)
                    .attr("stroke", "rgba(255,255,255,0.05)")
                    .attr("stroke-dasharray", "4,4");

                // æ ‡ç­¾ä½ç½®
                const labelR = maxRadius + (isMobile ? 15 : 30);
                const labelX = Math.sin(angle) * labelR;
                const labelY = -Math.cos(angle) * labelR;
                
                // ç®€å•çš„é˜²ç¢°æ’é€»è¾‘ï¼šå¦‚æœè§’åº¦æ¥è¿‘æ°´å¹³ï¼Œå·¦å³å¯¹é½ï¼›å‚ç›´åˆ™å±…ä¸­
                let anchor = "middle";
                if (Math.abs(labelX) > 10) anchor = labelX > 0 ? "start" : "end";

                svg.append("text")
                    .attr("x", labelX)
                    .attr("y", labelY)
                    .attr("text-anchor", anchor)
                    .attr("dominant-baseline", "middle")
                    .attr("fill", CONFIG.colors.text)
                    .attr("font-size", isMobile ? "12px" : "14px")
                    .style("font-weight", "bold")
                    .text(stage);
            });

            // --- 3. è®¡ç®—æ‰€æœ‰æœ‹å‹çš„åæ ‡å¹¶å­˜å‚¨ ---
            // æˆ‘ä»¬éœ€è¦å…ˆè®¡ç®—å¥½ä½ç½®ï¼Œæ‰èƒ½ç”»æœ‹å‹ä¹‹é—´çš„è¿çº¿
            const nodeMap = {}; // ç”¨äºé€šè¿‡åå­—å¿«é€ŸæŸ¥æ‰¾åæ ‡

            const processedNodes = DATA.friends.map(d => {
                const bandwidth = angleScale.bandwidth();
                const startAngle = angleScale(d.stage);
                // éšæœºåˆ†å¸ƒï¼Œä½†ä¿ç•™ä¸¤è¾¹å„10%çš„è¾¹è·ï¼Œé˜²æ­¢å‹çº¿
                // ä½¿ç”¨ä¼ªéšæœºæ•°ç§å­æœ€å¥½ï¼Œä½†è¿™é‡Œä¸ºäº†ç®€å•ç”¨ Math.random
                // ä¸ºäº†é¿å…resizeæ—¶ä½ç½®ä¹±è·³ï¼Œå¯ä»¥åœ¨çœŸå®é¡¹ç›®ä¸­å¼•å…¥ seedrandom
                const randomOffset = Math.random() * (bandwidth * 0.8) + (bandwidth * 0.1); 
                const angle = startAngle + randomOffset;
                const r = radiusScale(d.distance);

                const x = Math.sin(angle) * r;
                const y = -Math.cos(angle) * r;

                // å­˜å…¥ map
                nodeMap[d.name] = { x, y };

                return { ...d, x, y, rVal: r };
            });

            // --- 4. ç»˜åˆ¶æœ‹å‹é—´çš„å…³ç³» (Internal Relationships) ---
            const relGroup = svg.append("g").attr("class", "rel-group");
            
            DATA.relationships.forEach(rel => {
                const start = nodeMap[rel.source];
                const end = nodeMap[rel.target];

                if (start && end) {
                    // ç”»çº¿
                    relGroup.append("line")
                        .attr("x1", start.x).attr("y1", start.y)
                        .attr("x2", end.x).attr("y2", end.y)
                        .attr("stroke", "rgba(255, 255, 255, 0.4)")
                        .attr("stroke-width", 1)
                        .attr("stroke-dasharray", rel.dashed ? "3,3" : "0")
                        .attr("marker-end", rel.arrow ? "url(#arrow-marker)" : null);

                    // ç”»æ ‡ç­¾æ–‡å­— (åœ¨çº¿æ®µä¸­é—´)
                    const midX = (start.x + end.x) / 2;
                    const midY = (start.y + end.y) / 2;
                    
                    // ç»™æ–‡å­—åŠ ä¸ªèƒŒæ™¯é»‘å—ï¼Œé˜²æ­¢çœ‹ä¸æ¸…
                    relGroup.append("rect")
                        .attr("x", midX - 15).attr("y", midY - 8)
                        .attr("width", 30).attr("height", 16)
                        .attr("fill", "rgba(0,0,0,0.6)")
                        .attr("rx", 4);

                    relGroup.append("text")
                        .attr("x", midX).attr("y", midY)
                        .attr("text-anchor", "middle")
                        .attr("dominant-baseline", "middle")
                        .attr("fill", "#fff")
                        .attr("font-size", "9px")
                        .text(rel.label);
                }
            });

            // --- 5. ç»˜åˆ¶è¿æ¥åœ†å¿ƒçš„çº¿ ---
            svg.selectAll(".link-center")
                .data(processedNodes)
                .enter()
                .append("line")
                .attr("x1", 0).attr("y1", 0)
                .attr("x2", d => d.x).attr("y2", d => d.y)
                .attr("stroke", d => colorScale(d.gender))
                .attr("stroke-width", 1)
                .attr("opacity", 0.2)
                .attr("stroke-dasharray", d => d.contact ? "0" : "3,3");

            // --- 6. ç»˜åˆ¶èŠ‚ç‚¹ (æ˜Ÿçƒ) ---
            const nodeGroup = svg.selectAll(".node")
                .data(processedNodes)
                .enter()
                .append("g")
                .attr("class", "node")
                .style("cursor", "pointer");

            nodeGroup.append("circle")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                // äº²å¯†è·ç¦»<20çš„æ˜¯å¤§çƒï¼Œå…¶ä»–æ˜¯å°çƒ
                .attr("r", d => d.distance < 20 ? (isMobile?10:14) : (isMobile?6:8)) 
                .attr("fill", d => colorScale(d.gender))
                .style("filter", "url(#glow)")
                .attr("stroke", "white")
                .attr("stroke-width", 0)
                .transition().duration(1000)
                .attr("opacity", 0.9);

            // --- 7. ç»˜åˆ¶åœ†å¿ƒ (æˆ‘) ---
            svg.append("circle")
                .attr("r", isMobile ? 10 : 16)
                .attr("fill", CONFIG.colors.center)
                .style("filter", "url(#glow)");
            
            svg.append("text")
                .attr("y", isMobile ? 25 : 35)
                .attr("text-anchor", "middle")
                .attr("fill", CONFIG.colors.center)
                .attr("font-size", "12px")
                .text("æˆ‘");

            // --- 8. äº¤äº’é€»è¾‘ (Tooltip) ---
            const tooltip = d3.select("#tooltip");

            nodeGroup.on("mouseover", function(event, d) {
                // æ”¾å¤§
                d3.select(this).select("circle")
                    .transition().duration(200)
                    .attr("stroke-width", 2)
                    .attr("r", d.distance < 20 ? (isMobile?14:18) : (isMobile?8:12));

                // æ„å»º Tooltip å†…å®¹ (å¤„ç†ç©ºå€¼)
                let tagsHtml = "";
                if (d.gender) tagsHtml += `<span class="tag" style="background:${d.gender==='å¥³'?'#ff4d94':'#00d2ff'}">${d.gender}</span>`;
                if (d.stage) tagsHtml += `<span class="tag">${d.stage}</span>`;
                if (d.mbti) tagsHtml += `<span class="tag mbti">${d.mbti}</span>`;
                if (d.character) tagsHtml += `<span class="tag">${d.character}</span>`;

                const storyHtml = d.story ? `<div class="story">â€œ${d.story}â€</div>` : "";
                const contactStatus = d.contact ? "âœ¨ ä¿æŒè”ç³»" : "ğŸ‚ æš‚æ— è”ç³»";

                tooltip.style("opacity", 1)
                    .html(`
                        <h3>${d.name} <span style="font-size:10px; opacity:0.7">${contactStatus}</span></h3>
                        <div class="tags">${tagsHtml}</div>
                        ${storyHtml}
                    `);
            })
            .on("mousemove", function(event) {
                // è·Ÿéšé¼ æ ‡
                tooltip.style("left", (event.pageX) + "px")
                       .style("top", (event.pageY) + "px");
            })
            .on("mouseout", function(event, d) {
                // æ¢å¤
                d3.select(this).select("circle")
                    .transition().duration(200)
                    .attr("stroke-width", 0)
                    .attr("r", d.distance < 20 ? (isMobile?10:14) : (isMobile?6:8));
                tooltip.style("opacity", 0);
            });
        }

        // èƒŒæ™¯æ˜Ÿç©ºç”Ÿæˆ
        function createStars() {
            for(let i=0; i<80; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 2 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.left = Math.random() * 100 + 'vw';
                star.style.top = Math.random() * 100 + 'vh';
                star.style.animationDuration = (Math.random() * 3 + 2) + 's';
                document.body.appendChild(star);
            }
        }

        // å¯åŠ¨
        init();

    </script>
</body>
</html>
