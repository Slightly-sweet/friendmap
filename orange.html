<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂêÉ‰∏™Ê©òÂ≠êÂêßÁöÑFriend map</title>
    <!-- ÂºïÂÖ• D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            background-color: #050505;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            -webkit-tap-highlight-color: transparent;
        }

        /* ÊÇ¨ÂÅúÂç°Áâá */
        #tooltip {
            position: fixed;
            opacity: 0;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            pointer-events: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 1);
            width: 260px;
            z-index: 1000;
            transition: opacity 0.2s ease;
            font-size: 13px;
        }
        #tooltip h3 { margin: 0 0 5px 0; color: #fff; font-size: 1.1em; letter-spacing: 1px; }
        #tooltip .tags { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        #tooltip .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.15); color: #ddd; border: 1px solid rgba(255,255,255,0.1); }
        #tooltip p { margin: 0; line-height: 1.6; color: #ccc; }
        
        /* ÁâπÊÆäÊ†áÁ≠æÈ¢úËâ≤ */
        .tag.hometown { border-color: #00d2ff; color: #00d2ff; background: rgba(0, 210, 255, 0.1); }
        .tag.disconnected { border-color: #666; color: #888; background: transparent; border-style: dashed; }

        /* ÊéßÂà∂Èù¢Êùø */
        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.3);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #ddd;
        }
        
        .switch { position: relative; display: inline-block; width: 36px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00d2ff; }
        input:checked + .slider:before { transform: translateX(18px); }

        /* ÊòüÊòüÂä®Áîª */
        .star { 
            position: absolute; 
            background: white; 
            border-radius: 50%; 
            box-shadow: 0 0 4px rgba(255,255,255,0.8);
            animation: twinkle var(--duration) infinite ease-in-out; 
        }
        @keyframes twinkle { 
            0%, 100% { opacity: 0.3; transform: scale(0.8); } 
            50% { opacity: 1; transform: scale(1.2); } 
        }

        /* ÂúàÂ≠êÊ†áÁ≠æ */
        .group-label {
            font-size: 11px;
            font-weight: bold;
            opacity: 0.9;
            text-shadow: 0 0 3px #000, 0 0 5px #000;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="tooltip"></div>

    <div class="controls">
        <span>ÂúàÂ≠ê & ËøûÁ∫ø</span>
        <label class="switch">
            <input type="checkbox" id="toggleRelations" checked>
            <span class="slider"></span>
        </label>
    </div>

    <script>
        // ==========================================
        // üõ†Ô∏è Êï∞ÊçÆÈÖçÁΩÆÂå∫Âüü
        // ==========================================

        const customOrder = ["Â∞èÂ≠¶", "È´ò‰∏≠", "Êú¨Áßë", "Á°ïÂ£´", "ÂÆû‰π†"];

        // Êï∞ÊçÆËØ¥ÊòéÔºö
        // distance: Ë∂äÂ∞èË∂ä‰∫≤ÂØÜ„ÄÇ >90 ËßÜ‰∏∫Êñ≠ËÅî„ÄÇ
        // keyword: ‰ºöÊòæÁ§∫‰∏∫Ê†áÁ≠æ
        const friendsData = [
            // --- Â∞èÂ≠¶ ---
            { name: "Ëî°ÊñáÂçö", stage: "Â∞èÂ≠¶", distance: 101, contact: false, gender: "Áî∑", hometown: "ÊµôÊ±üÊ∏©Â∑ûËãçÂçó", keyword: "ÂèëÂ∞è", story: "Â∞èÂ≠¶ÊúÄÂ•ΩÁöÑÊúãÂèã„ÄÇ‰∏ÄËµ∑ÂÅ∑Ê°ëËëöÔºåÁ∫¶ÂÆöËÄÉÊ∏ÖÂåó„ÄÇ‰ΩÜÂ§ßÂ≠¶ÂêéÂΩªÂ∫ïÊñ≠ËÅîÔºåÊÑüËßâ‰ªñÂèò‰∫Ü‰∏Ä‰∏™‰∫∫„ÄÇ" },

            // --- È´ò‰∏≠ ---
            { name: "Â≠ô‰∫åÁãó", stage: "È´ò‰∏≠", distance: 16, contact: true, gender: "Áî∑", hometown: "ÊµôÊ±üÈáëÂçéÊ≠¶‰πâ", keyword: "sb/Ê≠ªÂÖö", story: "È´ò‰∏≠ÊúÄÂ•ΩÁöÑÊúãÂèã„ÄÇ‰∏ÄËµ∑‰∏ãÂÜõÊ£ãË¢´ÊäìÔºåÁøòËØæË∏¢ÁêÉÔºåÁøòÊôöËØªÁúãÊúà‰∫Æ„ÄÇ" },
            { name: "ÊΩòÊ•∑Èò≥", stage: "È´ò‰∏≠", distance: 31, contact: true, gender: "Áî∑", hometown: "ÊµôÊ±üÈáëÂçéÊ≠¶‰πâ", keyword: "Áâ©ÁêÜËØæ‰ª£Ë°®", story: "‰∏ÄËµ∑ÂèÇÂä†Ëøá2Ê¨°ËøêÂä®‰ºöÊé•ÂäõËµõ„ÄÇÊúãÂèãÂúàÂèëemoÊñáÊ°àÁöÑÈÇ£‰Ωç„ÄÇ" },
            { name: "ÈôàÂáåÊû´", stage: "È´ò‰∏≠", distance: 31, contact: true, gender: "Áî∑", hometown: "ÊµôÊ±üÈáëÂçéÊ≠¶‰πâ", keyword: "‰ΩìÂßî", story: "‰∏ÄËµ∑ÂèÇÂä†ËøáÊé•ÂäõËµõ„ÄÇÈò¥Â∑ÆÈò≥Èîô‰∏ÄËµ∑Âú®Â•ΩÊú™Êù•ÂÆû‰π†ËøáÔºå‰ΩÜ‰∏âÂπ¥Ê≤°ËßÅ‰∫Ü„ÄÇ" },

            // --- Êú¨Áßë ---
            { name: "‰Ω≥ÊÄ°Âßê", stage: "Êú¨Áßë", distance: 16, contact: true, gender: "Â•≥", hometown: "ÊµôÊ±ü‰∏ΩÊ∞¥Áºô‰∫ë", keyword: "Èô¢Â£´Âúà1Êâπ", story: "‰øùÁ†îÊúÄÈ°∫Âà©ÁöÑÔºåÊîæÂºÉÂåóÂ§ßÂéª‰∫ÜÊ≠¶Â§ß„ÄÇÁªôÊàëÈÄÅË¥∫Âç°ÁöÑÊúãÂèã„ÄÇ" },
            { name: "ÂÆ∂‰πêÂì•Âì•", stage: "Êú¨Áßë", distance: 16, contact: true, gender: "Áî∑", hometown: "ÊµôÊ±üÂè∞Â∑û", keyword: "Èô¢Â£´Âúà1Êâπ", story: "ÂÖ≠Á∫ßÈöæÂÖÑÈöæÂºü„ÄÇË°®Èù¢ÂòªÂòªÂìàÂìàÂÖ∂ÂÆûË¥üÈù¢ÊÉÖÁª™Â§ö„ÄÇ‰ΩÜÊàëÊâæ‰ªñÂî±Ê≠åËÅöÈ§ê‰ªñ‰ªé‰∏çÊãíÁªù„ÄÇ" },
            { name: "Âç¢ÂÆáÊ∂õ", stage: "Êú¨Áßë", distance: 16, contact: true, gender: "Áî∑", hometown: "ÊµôÊ±üÁªçÂÖ¥", keyword: "Èô¢Â£´Âúà2Êâπ", story: "Â∞è‰∏ÄÂ±ä„ÄÇÁà±ÊêûÊäΩË±°ÔºåÂ∏∏ÂéªÁõ∏‰∫≤ÔºåÁà±Êç¢Á∫ØÈªëÂ§¥ÂÉèË£ÖEMO„ÄÇ" },
            { name: "ÊäΩÁÉüÂì•üö¨", stage: "Êú¨Áßë", distance: 16, contact: true, gender: "Áî∑", hometown: "ÊπñÂçóÂÆâÈò≥", keyword: "ÂÆ§Âèã", story: "ÂàùËØïÁä∂ÂÖÉ‰ΩÜÂ§çËØïÊ≤°ÂáÜÂ§á„ÄÇÂ§©Â§©ÊäΩÁÉüÔºå‰ΩÜÂ∏ÆÊàëÂíåÈô¢Â£´‰ª¨Âç†ËøáÂ∫ß„ÄÇ" },
            { name: "zdc", stage: "Êú¨Áßë", distance: 16, contact: false, gender: "Áî∑", hometown: "Ê±üËãèÂ∏∏Â∑û", keyword: "ÂÆ§Âèã", story: "ÂèòÊàêÊòüÊòüÂï¶‚ú®„ÄÇ‰πãÂâç‰ªãÁªçËøáÂ∏∏Â∑ûÁöÑÊÅêÈæôÔºå‰ª•ÂêéÊàë‰∏ÄÂÆö‰ºöÂéªÁúãÁúã„ÄÇ" }, // Ê≥®ÔºöÂèòÊàêÊòüÊòü‰∫ÜÔºåËÆæ‰∏∫falseÁî®ËôöÁ∫øË°®Á§∫ÊÄÄÂøµ
            { name: "Ëâ∫ËäØËÄÅÂ∏à", stage: "Êú¨Áßë", distance: 16, contact: true, gender: "Â•≥", hometown: "ÊµôÊ±üÈáëÂçéÂ©∫Âüé", keyword: "ÂÆû‰π†Êê≠Â≠ê", story: "Ââç‰∏âÂπ¥Êó†‰∫§ÈõÜÔºåÂø´ÊâãÂÆû‰π†ÊâçÁÜüÁªú„ÄÇÊîæÂºÉËã±ÂõΩÂéª‰∫ÜËç∑ÂÖ∞ËØªÁ†î„ÄÇ" },
            { name: "Â§ßÂèî", stage: "Êú¨Áßë", distance: 21, contact: true, gender: "Â•≥", hometown: "ÊµôÊ±üÈáëÂçéÂ©∫Âüé", keyword: "Èô¢Â£´Âúà2Êâπ", story: "ÂÅöÁè†ÂÆùÁöÑÂ•ΩÂèã„ÄÇË¢´È™óÊó∂ÂäùÊàëÁúãÂºÄ„ÄÇÂ§ß‰∫å‰∏ÄËµ∑ÊâìÊØîËµõ„ÄÇ" },
            { name: "Êú±Ê≤õÊµ©", stage: "Êú¨Áßë", distance: 26, contact: true, gender: "Áî∑", hometown: "ÊµôÊ±üÂè∞Â∑ûÁéâÁéØ", keyword: "Èô¢Â£´Âúà1Êâπ", story: "ÂîØ‰∏ÄÂêåÂ≠¶Èô¢ÁöÑÈô¢Â£´„ÄÇÂ≠¶Ê≥ïÂ≠¶Ôºå‰ºöËÅä‰øùÁ†îËßÑÂàôÂíåÊØîËµõÁªèÈ™å„ÄÇ" },
            { name: "È•≠È•≠", stage: "Êú¨Áßë", distance: 31, contact: true, gender: "Áî∑", hometown: "ÊµôÊ±ü‰∏ΩÊ∞¥Â∫ÜÂÖÉ", keyword: "Èô¢Â£´Âúà1Êâπ", story: "ÁÉ≠Áà±Âú∞Ë¥®1Âè∑„ÄÇËÆ§ËØÜÁöÑÁ¨¨‰∏Ä‰∏™Â§ßÂ≠¶ÂêåÂ≠¶Ôºå‰∏ÄËµ∑ÂêÉÂêâÈáéÂÆ∂„ÄÇÂÆ∂Â¢É‰∏ÄËà¨‰ΩÜÊÄßÊ†ºÊûÅÂ•Ω‰∏îËá™Âº∫„ÄÇ" },
            { name: "Â∞èËä±", stage: "Êú¨Áßë", distance: 31, contact: true, gender: "Áî∑", hometown: "ÊµôÊ±üÈáëÂçéÈáë‰∏ú", keyword: "Èô¢Â£´Âúà1Êâπ", story: "ÁÉ≠Áà±Âú∞Ë¥®2Âè∑„ÄÇÊú¨ÁßëÂàõÊñ∞Áè≠Ôºå‰øùÁ†îÊú¨Ê†°Áõ¥Âçö„ÄÇ" },
            { name: "Êç∑Ë±π", stage: "Êú¨Áßë", distance: 31, contact: true, gender: "Â•≥", hometown: "ÊµôÊ±üÊù≠Â∑ûË•øÊπñ", keyword: "Èô¢Â£´Âúà2Êâπ", story: "Â≠¶Áè†ÂÆùËÆæËÆ°ÔºåÂíåÂ§ßÂèîÂêå‰∏ì‰∏ö„ÄÇ‰∏ÄËà¨ÂíåÂ§ßÂèî„ÄÅ011Áé©ÂæóÂ§ö„ÄÇ" },
            { name: "Â≠êÊÄ°", stage: "Êú¨Áßë", distance: 31, contact: true, gender: "Â•≥", hometown: "ÊµôÊ±üÂòâÂÖ¥", keyword: "Èô¢Â£´Âúà1Êâπ", story: "ÁÉ≠Áà±Âú∞Ë¥®3Âè∑„ÄÇ‰øùÁ†î‰∏≠ÁßëÈô¢ÔºåÁà±ÊîÄÂ≤©ÂæíÊ≠•ÊëÑÂΩ±„ÄÇ" },
            { name: "ÈòøÂØ∞", stage: "Êú¨Áßë", distance: 31, contact: true, gender: "Áî∑", hometown: "ÊµôÊ±üÁªçÂÖ¥", keyword: "ÁºñÂ§ñ‰∫∫Â£´", story: "‰Ω≥ÊÄ°ÂßêÁî∑Âèã„ÄÇ‰∏ÄËµ∑Ëá™È©æÂéªËøá‰πåÂÖ∞Â∏ÉÁªü„ÄÇ" },
            { name: "Êù®ÂçöÊ£ã", stage: "Êú¨Áßë", distance: 31, contact: true, gender: "Áî∑", hometown: "ÊµôÊ±üÈáëÂçé‰∏úÈò≥", keyword: "ÊëáÁØÆÂúà", story: "Êñ∞Â™í‰ΩìÊëÑÂΩ±ÈÉ®Èïø„ÄÇÂéªÂª∂ÂÆâÊãçÊëÑËÆ§ËØÜÁöÑËÄÅ‰π°„ÄÇÂ∏¶ÊàëËøõË°å‰∫ÜÁ¨¨‰∏ÄÊ¨°Â§ßÂ≠¶Ëá™È©æ„ÄÇ" },
            { name: "‰Ω≥ËÉΩ", stage: "Êú¨Áßë", distance: 31, contact: true, gender: "Áî∑", hometown: "ÊµôÊ±üÁªçÂÖ¥", keyword: "ÁºñÂ§ñ‰∫∫Â£´", story: "ÂíåÂæêÂÆ∂‰πêÂêå‰∏ì‰∏ö„ÄÇËá™Áß∞‰∏ãÂ§¥Áî∑ÂÖ∂ÂÆûÊñáË¥®ÂΩ¨ÂΩ¨„ÄÇÁõÆÂâçÂú®ÈáëÂçéÂ∑•‰Ωú„ÄÇ" },
            { name: "Âº†ÊÄ°Áùø", stage: "Êú¨Áßë", distance: 31, contact: true, gender: "Â•≥", hometown: "Ê≤≥ÂåóÂº†ÂÆ∂Âè£", keyword: "Âõ¢ÊîØ‰π¶", story: "ÂÅö‰∫ãË¥üË¥£„ÄÇÊàëÁöÑÂ∞èÁªÑ‰Ωú‰∏öÊê≠Ê°£„ÄÇÂíåÊ∏∏‰Ω≥Ëã±ÊòØÈó∫Ëúú„ÄÇ" },
            { name: "Ê∏∏‰Ω≥Ëã±", stage: "Êú¨Áßë", distance: 31, contact: true, gender: "Â•≥", hometown: "ÊµôÊ±üÈáëÂçéÂÖ∞Ê∫™", keyword: "ÁºñÂ§ñ‰∫∫Â£´", story: "ÂêåÁè≠ËÄÅ‰π°„ÄÇÈïøÂæóÂ•ΩÁúã„ÄÇÂíåÂº†ÊÄ°ÁùøÊòØÈó∫Ëúú„ÄÇ" },
            { name: "011", stage: "Êú¨Áßë", distance: 91, contact: false, gender: "Áî∑", hometown: "ÊµôÊ±üÂè∞Â∑û", keyword: "Èô¢Â£´Âúà2Êâπ", story: "‰∫∫ÊòØÂ•Ω‰∫∫„ÄÇ‰ΩÜÊàëÂâç‰ªªÁöÑÂâç‰ªª...Áõ∏Â§ÑÂ∞¥Â∞¨ÔºåÂ∑≤Êñ≠ËÅî„ÄÇ" },

            // --- Á°ïÂ£´ ---
            { name: "Â∑¢ËÄÅÂ∏à", stage: "Á°ïÂ£´", distance: 16, contact: true, gender: "Â•≥", hometown: "Ê±üË•ø‰πùÊ±ü", keyword: "ÂêåÈó®", story: "Â§ñË°®ÂºÄÊúóÂÜÖÂøÉÂÜÖËÄó„ÄÇÊâæÂ•πË¶ÅËøáÁ≠æÂà∞Á†Å„ÄÇÊâìÁÆóËÄÉÂÖ¨„ÄÇ" },
            { name: "ÈªÑÊãØ‰πã", stage: "Á°ïÂ£´", distance: 31, contact: true, gender: "Áî∑", hometown: "Á¶èÂª∫Âé¶Èó®", keyword: "ÂÆ§Âèã", story: "„ÄäÈ´òÁ∫ßÁ§æ‰ºöÁªüËÆ°Â≠¶„Äã‰Ωú‰∏öÈÉΩÊòØÊàëÊâìÂç∞ËÆ©‰ªñÂ∏Æ‰∫§ÁöÑ„ÄÇ" },

            // --- ÂÆû‰π† ---
            { name: "Â∞èÂÄ™", stage: "ÂÆû‰π†", distance: 21, contact: true, gender: "Áî∑", hometown: "Ê±üËãèÂçóÈÄö", keyword: "Âø´Êâã", story: "ÂäùÊàëËØªÁ†îÊúÄÁßØÊûÅÁöÑ‰∫∫„ÄÇÁü•ÈÅìÊàë‰∫åËøõÂÆ´Âø´ÊâãÂêéÊúÄÊÉ≥Êù•ÊâæÊàëÁöÑ‰∫∫„ÄÇ" },
            { name: "ÂæêÁèÇÈì≠", stage: "ÂÆû‰π†", distance: 21, contact: true, gender: "Áî∑", hometown: "Ê≤≥Âçó", keyword: "Âø´Êâã", story: "‰∫åËøõÂÆ´È•≠Êê≠Â≠ê„ÄÇÁªèÂéÜ‰∏∞ÂØåÔºö‰∫åÊú¨->ATMÈîÄÂîÆ->Â≠óËäÇ->ËµåÂçö->Âø´Êâã„ÄÇ" },
            { name: "Á•éÊô®", stage: "ÂÆû‰π†", distance: 31, contact: true, gender: "Â•≥", hometown: "ÁîòËÇÉÂº†Êéñ", keyword: "Âø´Êâã", story: "ÈöîÂ£ÅÁªÑÂÆû‰π†Áîü„ÄÇÁ¶ªËÅåÈÄÅ‰∫ÜÊàëÈáëÈì≤Èì≤Áõ≤Áõí„ÄÇ" },
        ];

        // ÂúàÂ≠êÈÖçÁΩÆ (Ëá™Âä®‰∏äËâ≤)
        const groupsData = [
            // Èô¢Â£´Âúà‰∫∫Êï∞Â§™Â§öÔºåÊãÜÂàÜ‰∏Ä‰∏ãËßÜËßâÊïàÊûúÊõ¥Â•Ω
            { members: ["‰Ω≥ÊÄ°Âßê", "ÂÆ∂‰πêÂì•Âì•", "È•≠È•≠", "Â∞èËä±", "Â≠êÊÄ°", "Êú±Ê≤õÊµ©"], label: "Èô¢Â£´ÂúàÊ†∏ÂøÉ" },
            { members: ["Âç¢ÂÆáÊ∂õ", "Â§ßÂèî", "Êç∑Ë±π", "011"], label: "Èô¢Â£´ÂúàÂàÜÈÉ®" }, 
            { members: ["ÊΩòÊ•∑Èò≥", "ÈôàÂáåÊû´"], label: "È´ò‰∏≠Êé•ÂäõÁªÑ" },
            { members: ["Â§ßÂèî", "Êù®ÂçöÊ£ã"], label: "ÊëáÁØÆÂúà" },
            { members: ["ÊäΩÁÉüÂì•üö¨", "zdc"], label: "Êú¨ÁßëÂÆ§Âèã" },
            { members: ["Âº†ÊÄ°Áùø", "Ê∏∏‰Ω≥Ëã±"], label: "Èó∫Ëúú" },
            { members: ["‰Ω≥ÊÄ°Âßê", "ÈòøÂØ∞"], label: "ÊÉÖ‰æ£" },
        ];

        const relationsData = [];

        // ==========================================
        // ‚öôÔ∏è Ê†∏ÂøÉÈÄªËæë
        // ==========================================

        function init() {
            d3.select("body").selectAll("svg").remove();

            const width = window.innerWidth;
            const height = window.innerHeight;
            const maxRadius = Math.min(width, height) * 0.40; 
            
            const svg = d3.select("body").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", [ -width / 2, -height / 2, width, height ])
                .style("max-width", "100%")
                .style("height", "auto");

            const mainG = svg.append("g");

            // --- 1. È´òÊ∏ÖÊª§Èïú & ËµÑÊ∫êÂÆö‰πâ ---
            const defs = svg.append("defs");
            const filter = defs.append("filter").attr("id", "glow").attr("x", "-100%").attr("y", "-100%").attr("width", "300%").attr("height", "300%");
            filter.append("feGaussianBlur").attr("stdDeviation", "3.5").attr("result", "coloredBlur");
            const feMerge = filter.append("feMerge");
            feMerge.append("feMergeNode").attr("in", "coloredBlur");
            feMerge.append("feMergeNode").attr("in", "SourceGraphic");

            // --- 2. ÊâáÂå∫‰∏éËÉåÊôØÁ∫ø ---
            const stageCounts = d3.rollups(friendsData, v => v.length, d => d.stage);
            const stageMap = new Map(stageCounts);
            let allStages = Array.from(stageMap.keys());
            allStages.sort((a, b) => {
                let ia = customOrder.indexOf(a); let ib = customOrder.indexOf(b);
                if (ia === -1) ia = 999; if (ib === -1) ib = 999;
                return ia - ib;
            });
            
            const pie = d3.pie().value(d => stageMap.get(d)).sort(null).padAngle(0.1);
            const arcs = pie(allStages);
            const angleMap = {};
            arcs.forEach(d => { angleMap[d.data] = { start: d.startAngle, end: d.endAngle, mid: (d.startAngle + d.endAngle) / 2 }; });

            const sectorG = mainG.append("g").attr("class", "sectors");
            arcs.forEach(d => {
                const rLabel = maxRadius + 35;
                const midAngle = (d.startAngle + d.endAngle) / 2;
                const labelX = Math.sin(midAngle) * rLabel;
                const labelY = -Math.cos(midAngle) * rLabel;

                // Â¢ûÂº∫ÂàÜÂå∫Á∫ø
                const lineX = Math.sin(d.startAngle) * (maxRadius + 15);
                const lineY = -Math.cos(d.startAngle) * (maxRadius + 15);
                sectorG.append("line")
                    .attr("x1", 0).attr("y1", 0).attr("x2", lineX).attr("y2", lineY)
                    .attr("stroke", "rgba(255,255,255,0.2)") 
                    .attr("stroke-width", 1.5) 
                    .attr("stroke-dasharray", "5,5");

                sectorG.append("text")
                    .attr("x", labelX).attr("y", labelY)
                    .attr("text-anchor", "middle").attr("dominant-baseline", "middle")
                    .attr("fill", "#aaa").attr("font-size", "14px").attr("font-weight", "bold")
                    .text(d.data);
            });

            // --- 3. ËäÇÁÇπËÆ°ÁÆó ---
            const radiusScale = d3.scaleLinear().domain([0, 100]).range([50, maxRadius]);

            const nodes = friendsData.map(d => {
                const angleInfo = angleMap[d.stage];
                const bandwidth = angleInfo.end - angleInfo.start;
                const randomOffset = (Math.random() - 0.5) * (bandwidth * 0.7); 
                const angle = angleInfo.mid + randomOffset;
                
                // Ë∑ùÁ¶ªÊò†Â∞Ñ
                const clampedDist = Math.min(d.distance, 110);
                const r = radiusScale(clampedDist);
                const tx = Math.sin(angle) * r;
                const ty = -Math.cos(angle) * r;

                return { 
                    ...d, 
                    x: tx, y: ty, 
                    targetX: tx, targetY: ty, 
                    radius: d.distance < 20 ? 16 : 10 
                };
            });

            // --- 4. Áâ©ÁêÜÂºïÊìé ---
            const simulation = d3.forceSimulation(nodes)
                .force("x", d3.forceX(d => d.targetX).strength(0.8))
                .force("y", d3.forceY(d => d.targetY).strength(0.8))
                .force("collide", d3.forceCollide(d => d.radius + 15).iterations(4))
                .stop();

            for (let i = 0; i < 300; i++) simulation.tick();

            const nameToNode = {};
            nodes.forEach(n => nameToNode[n.name] = n);

            // --- 5. ÂúàÂ≠êÁªòÂà∂ ---
            const groupLayer = mainG.append("g").attr("class", "group-layer");
            const groupColorScale = d3.scaleOrdinal(d3.schemeSet2); 

            groupsData.forEach((group, i) => {
                const members = group.members.map(name => nameToNode[name]).filter(n => n);
                if (members.length < 2) return;

                const color = groupColorScale(i); 
                const points = members.map(d => [d.x, d.y]);
                let hullPath = "";
                let center = [0,0];

                if (members.length === 2) {
                    hullPath = `M${points[0][0]},${points[0][1]} L${points[1][0]},${points[1][1]}`;
                    center = [(points[0][0]+points[1][0])/2, (points[0][1]+points[1][1])/2];
                } else {
                    const hull = d3.polygonHull(points);
                    if (hull) {
                        const lineGen = d3.line().curve(d3.curveCatmullRomClosed.alpha(0.5));
                        hullPath = lineGen(hull);
                        center = d3.polygonCentroid(hull);
                    }
                }

                if (hullPath) {
                    const gGroup = groupLayer.append("g");
                    gGroup.append("path").attr("d", hullPath).attr("fill", "none").attr("stroke", color)
                        .attr("stroke-width", 1.5).attr("stroke-dasharray", "6,4")
                        .attr("stroke-width", members.length === 2 ? 20 : 1.5) 
                        .attr("stroke-opacity", members.length === 2 ? 0.2 : 1)
                        .attr("stroke-linejoin", "round");
                    
                    if (members.length > 2) {
                         gGroup.append("path").attr("d", hullPath).attr("fill", color).attr("fill-opacity", 0.05)
                            .attr("stroke", color).attr("stroke-width", 2).attr("stroke-dasharray", "5,5");
                    }
                    gGroup.append("text").attr("class", "group-label").attr("x", center[0]).attr("y", center[1])
                        .attr("text-anchor", "middle").attr("fill", color).text(group.label);
                }
            });

            // --- 6. ËäÇÁÇπËøûÁ∫ø & ÊòüÁêÉ ---
            const linkG = mainG.append("g");
            linkG.selectAll("line").data(nodes).enter().append("line")
                .attr("x1", 0).attr("y1", 0).attr("x2", d => d.x).attr("y2", d => d.y)
                .attr("stroke", d => d.gender === "Â•≥" ? "#ff4d94" : "#00d2ff")
                .attr("stroke-width", 1).attr("opacity", 0.3)
                .attr("stroke-dasharray", d => d.contact ? "0" : "4,4");

            const nodeG = mainG.append("g");
            const circles = nodeG.selectAll("circle").data(nodes).enter().append("circle")
                .attr("r", d => d.distance < 20 ? 12 : 7)
                .attr("cx", d => d.x).attr("cy", d => d.y)
                .attr("fill", d => d.gender === "Â•≥" ? "#ff4d94" : "#00d2ff")
                .style("filter", "url(#glow)")
                .attr("stroke", "#fff")
                .attr("stroke-width", d => d.distance < 20 ? 2 : 1.5)
                .attr("stroke-dasharray", d => d.contact ? "0" : "3,2")
                .style("cursor", "pointer");

            // --- 7. Êàë ---
            const me = mainG.append("g").style("filter", "url(#glow)");
            me.append("circle").attr("r", 18).attr("fill", "#ffd700");
            me.append("text").attr("y", 5).attr("text-anchor", "middle").attr("fill", "#000")
              .style("font-size", "11px").style("font-weight", "bold").text("Êàë");

            // --- 8. ‰∫§‰∫í (Êô∫ËÉΩTooltip) ---
            const tooltip = d3.select("#tooltip");
            circles.on("click mouseover", function(event, d) {
                event.stopPropagation();
                d3.select(this).transition().attr("r", 18);
                
                let tagsHtml = `<span class="tag">${d.stage}</span>`;
                if(d.hometown) tagsHtml += `<span class="tag hometown">${d.hometown}</span>`;
                if(d.keyword) tagsHtml += `<span class="tag">${d.keyword}</span>`;
                if(!d.contact) tagsHtml += `<span class="tag disconnected">Â∑≤Êñ≠ËÅî</span>`;
                
                tooltip.html(`<h3>${d.name} <span style="font-size:0.7em;color:#fff;opacity:0.6">${d.gender}</span></h3><div class="tags">${tagsHtml}</div><p>‚Äú${d.story}‚Äù</p>`);
                
                const tipW = 270, tipH = 150; 
                let left = event.clientX + 15;
                let top = event.clientY - tipH/2;
                if (left + tipW > window.innerWidth) left = event.clientX - tipW - 15;
                if (top < 0) top = 10;
                if (top + tipH > window.innerHeight) top = window.innerHeight - tipH - 10;

                tooltip.style("opacity", 1).style("left", left + "px").style("top", top + "px");

            }).on("mouseout", function() {
                d3.select(this).transition().attr("r", d => d.distance < 20 ? 12 : 7);
                tooltip.style("opacity", 0).style("left", "-9999px");
            });

            svg.on("click", () => tooltip.style("opacity", 0).style("left", "-9999px"));

            // ÂºÄÂÖ≥
            const toggle = document.getElementById('toggleRelations');
            toggle.addEventListener('change', () => {
                const opacity = toggle.checked ? 1 : 0;
                groupLayer.transition().style("opacity", opacity);
            });
        }

        function createStars() {
            for(let i=0; i<200; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() < 0.1 ? Math.random() * 3 + 2 : Math.random() * 2;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.left = Math.random() * 100 + 'vw';
                star.style.top = Math.random() * 100 + 'vh';
                star.style.setProperty('--duration', (Math.random() * 3 + 1.5) + 's');
                star.style.opacity = Math.random() * 0.7 + 0.3;
                document.body.appendChild(star);
            }
        }

        createStars();
        init();
        let resizeTimer;
        window.addEventListener('resize', () => { clearTimeout(resizeTimer); resizeTimer = setTimeout(init, 300); });
    </script>
</body>
</html>
