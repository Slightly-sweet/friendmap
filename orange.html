<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„æ˜Ÿç³»å¼•åŠ›å›¾ V2.0</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body {
            margin: 0;
            background-color: #0b0c10;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overflow: hidden; /* é˜²æ­¢æ»šåŠ¨æ¡ */
            height: 100vh;
            width: 100vw;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- äº¤äº’æ§åˆ¶é¢æ¿ --- */
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* å¼€å…³æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #66fcf1; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- èƒŒæ™¯æ˜Ÿæ˜ŸåŠ¨ç”» --- */
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            pointer-events: none; 
            animation: twinkle 3s infinite ease-in-out;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }

        /* --- æ‚¬åœå¡ç‰‡ (Tooltip) --- */
        #tooltip {
            position: absolute;
            opacity: 0;
            background: rgba(20, 20, 30, 0.85); /* æ·±è‰²èƒŒæ™¯æ›´æ˜“è¯» */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(102, 252, 241, 0.3);
            padding: 15px;
            border-radius: 8px;
            pointer-events: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            max-width: 260px;
            z-index: 20;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform: translate(-50%, -110%);
        }

        #tooltip h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #66fcf1;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 5px;
        }
        
        /* æ ‡ç­¾èƒ¶å›Šæ ·å¼ */
        .tag-container {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        .tag {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255,255,255,0.15);
            color: #eee;
        }
        .tag.mbti { background: #4e54c8; }
        .tag.personality { background: #11998e; }

        #tooltip p {
            margin: 5px 0 0 0;
            font-size: 13px;
            line-height: 1.6;
            color: #ddd;
            font-style: italic;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 600px) {
            #tooltip {
                width: 80%;
                max-width: none;
                /* ç§»åŠ¨ç«¯å›ºå®šåœ¨åº•éƒ¨æ˜¾ç¤ºï¼Œé˜²æ­¢é®æŒ¡ */
                top: auto !important;
                bottom: 20px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
            }
        }
    </style>
</head>
<body>

    <!-- 1. æ§åˆ¶é¢æ¿ -->
    <div id="controls">
        <span>æ˜¾ç¤ºæœ‹å‹é—´å…³ç³»</span>
        <label class="switch">
            <input type="checkbox" id="linkToggle" checked>
            <span class="slider"></span>
        </label>
    </div>

    <!-- 2. Tooltip å®¹å™¨ -->
    <div id="tooltip"></div>

    <!-- 3. SVG å®¹å™¨ç”± JS è‡ªåŠ¨ç”Ÿæˆ -->

    <script>
        // ==========================================
        // ğŸ› ï¸ æ•°æ®é…ç½®åŒº (DATA CONFIG)
        // ==========================================

        // 1. é˜¶æ®µé…ç½®ï¼šä½ å¯ä»¥ä»»æ„å¢åˆ ï¼Œè¿™é‡Œçš„é¡ºåºå†³å®šäº†å›¾ä¸Šçš„æ‰‡å½¢é¡ºåº
        // åªè¦åœ¨è¿™é‡ŒåŠ äº†åå­—ï¼Œå›¾è¡¨ä¼šè‡ªåŠ¨è°ƒæ•´è§’åº¦ï¼Œç”»å‡ºæ–°çš„åˆ†åŒº
        const stages = ["å°å­¦", "åˆä¸­", "é«˜ä¸­", "å¤§å­¦", "ç ”ç©¶ç”Ÿ", "å®ä¹ ", "ç¤¾å›¢", "å…¶ä»–"];

        // 2. æœ‹å‹æ•°æ®ï¼šæ–°å¢ mbti å’Œ personality (å…è®¸ä¸ºç©º)
        const friendsData = [
            // æ ¸å¿ƒå¥½å‹
            { name: "å¥½å®¤å‹A", stage: "ç ”ç©¶ç”Ÿ", distance: 15, contact: true, gender: "å¥³", mbti: "ENFP", personality: "å¿«ä¹å°ç‹—", story: "ç ”ä¸€æœ€å´©æºƒçš„æ—¶å€™é™ªæˆ‘é€šå®µæ”¹è®ºæ–‡ï¼Œè¿˜ç»™æˆ‘ç…®é¢åƒã€‚" },
            { name: "å‘å°F", stage: "å°å­¦", distance: 10, contact: true, gender: "å¥³", mbti: "", personality: "é¿é£æ¸¯", story: "è®¤è¯†20å¹´äº†ï¼Œç”šè‡³ä¸éœ€è¦è¯´è¯å°±çŸ¥é“å¯¹æ–¹åœ¨æƒ³ä»€ä¹ˆã€‚" },
            
            // é‡è¦ä¼™ä¼´
            { name: "å¸ˆå…„B", stage: "ç ”ç©¶ç”Ÿ", distance: 35, contact: true, gender: "ç”·", mbti: "INTJ", personality: "ä¸¥è°¨å¯¼å¸ˆ", story: "å¸¦æˆ‘å…¥é—¨çš„å¤§ç¥ï¼Œè™½ç„¶æ¯•ä¸šäº†ä½†ä¾ç„¶ä¼šæŒ‡å¯¼æˆ‘ã€‚" },
            { name: "å°èŠ±", stage: "å¤§å­¦", distance: 25, contact: true, gender: "å¥³", mbti: "ISFJ", personality: "", story: "å¤§å­¦å››å¹´çš„é¥­æ­å­ï¼Œä¹Ÿæ˜¯æˆ‘çš„æƒ…æ„Ÿåƒåœ¾æ¡¶ã€‚" },
            { name: "ç¤¾é•¿C", stage: "ç¤¾å›¢", distance: 60, contact: false, gender: "ç”·", mbti: "ENTJ", personality: "é¢†å¯¼è€…", story: "æ›¾ç»ä¸€èµ·åŠè¿‡æœ€å¤§çš„æ´»åŠ¨ï¼Œæ•™ä¼šæˆ‘ä»€ä¹ˆæ˜¯é¢†å¯¼åŠ›ã€‚" },
            { name: "åŒæ¡ŒD", stage: "é«˜ä¸­", distance: 30, contact: true, gender: "å¥³", mbti: "", personality: "", story: "æ™šè‡ªä¹ ä¸€èµ·çœ‹æ˜Ÿæ˜Ÿï¼Œè™½ç„¶å¼‚åœ°ä½†å¿ƒå¾ˆè¿‘ã€‚" },
            
            // å…¶ä»–æ¥æº
            { name: "Mentor E", stage: "å®ä¹ ", distance: 45, contact: true, gender: "å¥³", mbti: "INFJ", personality: "çŸ¥å¿ƒå§å§", story: "æˆ‘çš„èŒåœºå¼•è·¯äººã€‚" },
            { name: "ç½‘å‹G", stage: "å…¶ä»–", distance: 70, contact: true, gender: "ç”·", mbti: "INTP", personality: "äºŒæ¬¡å…ƒ", story: "å› ä¸ºæ‰“æ¸¸æˆè®¤è¯†çš„ï¼Œå¾ˆèŠå¾—æ¥ã€‚" },
        ];

        // 3. æœ‹å‹é—´çš„å…³ç³»è¿çº¿æ•°æ® (æ–°å¢åŠŸèƒ½)
        // å¿…é¡»ç¡®ä¿ source å’Œ target çš„åå­—åœ¨ä¸Šé¢çš„ friendsData é‡Œèƒ½æ‰¾åˆ°
        const relationshipData = [
            { source: "å¥½å®¤å‹A", target: "å¸ˆå…„B", type: "åŒé—¨" },
            { source: "å°èŠ±", target: "ç¤¾é•¿C", type: "å‰ä»»" },
            { source: "å¥½å®¤å‹A", target: "å°èŠ±", type: "ä»‹ç»è®¤è¯†" } 
        ];

        // ==========================================
        // ğŸš€ æ ¸å¿ƒä»£ç é€»è¾‘ (CORE LOGIC)
        // ==========================================

        let svg, width, height;

        // ç”ŸæˆèƒŒæ™¯æ˜Ÿæ˜Ÿ
        function createStars() {
            document.querySelectorAll('.star').forEach(e => e.remove());
            for(let i=0; i<80; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = Math.random() * 2 + 'px';
                star.style.height = star.style.width;
                star.style.left = Math.random() * 100 + 'vw';
                star.style.top = Math.random() * 100 + 'vh';
                star.style.animationDuration = (Math.random() * 3 + 2) + 's';
                document.body.appendChild(star);
            }
        }

        // ä¸»ç»˜å›¾å‡½æ•°
        function drawChart() {
            // 1. æ¸…ç†æ—§å›¾è¡¨
            d3.select("svg").remove();

            // 2. è·å–å½“å‰çª—å£å°ºå¯¸ï¼ˆå®ç°å“åº”å¼ï¼‰
            width = window.innerWidth;
            height = window.innerHeight;
            const centerX = width / 2;
            const centerY = height / 2;
            
            // åŠ¨æ€è®¡ç®—æœ€å¤§åŠå¾„ï¼šç¡®ä¿åœ¨æ‰‹æœºç«–å±æ—¶ä¹Ÿèƒ½æ”¾ä¸‹
            // å‡å»ä¸€äº›paddingé˜²æ­¢è¾¹ç¼˜æº¢å‡º
            const maxRadius = Math.min(width, height) / 2 - 50; 

            svg = d3.select("body").append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${centerX},${centerY})`);

            // 3. æ¯”ä¾‹å°ºå®šä¹‰
            const angleScale = d3.scaleBand()
                .domain(stages) // åŠ¨æ€ä½¿ç”¨æ‰€æœ‰é˜¶æ®µ
                .range([0, 2 * Math.PI])
                .align(0);

            const radiusScale = d3.scaleLinear()
                .domain([0, 100])
                .range([40, maxRadius]); // 40px æ˜¯ç•™ç»™ä¸­å¿ƒâ€œæˆ‘â€çš„åŒºåŸŸ

            const colorScale = (gender) => gender === "å¥³" ? "#ff4d94" : "#00d2ff";

            // 4. æ·»åŠ æ»¤é•œ
            const defs = svg.append("defs");
            const filter = defs.append("filter").attr("id", "glow");
            filter.append("feGaussianBlur").attr("stdDeviation", "2.5").attr("result", "coloredBlur");
            const feMerge = filter.append("feMerge");
            feMerge.append("feMergeNode").attr("in", "coloredBlur");
            feMerge.append("feMergeNode").attr("in", "SourceGraphic");

            // 5. ç»˜åˆ¶æ‰‡åŒºè¾…åŠ©çº¿å’Œæ ‡ç­¾
            stages.forEach(stage => {
                const angle = angleScale(stage) + angleScale.bandwidth() / 2;
                // è®©æ ‡ç­¾ç¨å¾®å¾€å¤–ä¸€ç‚¹
                const labelRadius = maxRadius + 20;
                
                const labelX = Math.sin(angle) * labelRadius;
                const labelY = -Math.cos(angle) * labelRadius;

                // ç»˜åˆ¶åˆ†éš”çº¿ (Start Angle)
                const startAngle = angleScale(stage);
                const lineX = Math.sin(startAngle) * maxRadius;
                const lineY = -Math.cos(startAngle) * maxRadius;
                
                svg.append("line")
                    .attr("x1", 0).attr("y1", 0)
                    .attr("x2", lineX).attr("y2", lineY)
                    .attr("stroke", "rgba(255,255,255,0.08)")
                    .attr("stroke-dasharray", "4,4");

                // ç»˜åˆ¶æ–‡å­—
                svg.append("text")
                    .attr("x", labelX)
                    .attr("y", labelY)
                    .attr("text-anchor", "middle")
                    .attr("dominant-baseline", "middle")
                    .attr("fill", "#888")
                    .attr("font-size", Math.min(width, height) < 600 ? "10px" : "14px") // æ‰‹æœºç«¯å­—ä½“å˜å°
                    .text(stage);
            });

            // 6. é¢„è®¡ç®—åæ ‡ (åŒ…å«éšæœºåç§»)
            // æˆ‘ä»¬éœ€è¦æŠŠåæ ‡å­˜ä¸‹æ¥ï¼Œä»¥ä¾¿åé¢ç”»æœ‹å‹é—´çš„è¿çº¿
            const nodePositions = {}; // å­˜å‚¨ {name: {x, y}}

            const processedData = friendsData.map(d => {
                const bandwidth = angleScale.bandwidth();
                const startAngle = angleScale(d.stage);
                
                // ç®€å•çš„ä¼ªéšæœºå“ˆå¸Œï¼Œä¿è¯åˆ·æ–°é¡µé¢æ—¶ä½ç½®ä¸å˜ï¼Œä½†æ¯ä¸ªäººä½ç½®ä¸åŒ
                // å¦‚æœæƒ³è¦æ¯æ¬¡åˆ·æ–°éƒ½å˜ï¼Œç”¨ Math.random()
                let seed = 0;
                for(let i=0; i<d.name.length; i++) seed += d.name.charCodeAt(i);
                const randomOffset = (seed % 100 / 100) * (bandwidth * 0.6) + (bandwidth * 0.2);
                
                const angle = startAngle + randomOffset;
                const r = radiusScale(d.distance);
                
                const x = Math.sin(angle) * r;
                const y = -Math.cos(angle) * r;

                // å­˜å…¥ä½ç½®å­—å…¸
                nodePositions[d.name] = { x, y };

                return { ...d, x, y };
            });

            // 7. ç»˜åˆ¶â€œæœ‹å‹é—´â€çš„å…³ç³»çº¿ (Feature 4)
            const relationsGroup = svg.append("g").attr("id", "relation-lines");
            
            relationshipData.forEach(rel => {
                const p1 = nodePositions[rel.source];
                const p2 = nodePositions[rel.target];

                if (p1 && p2) {
                    relationsGroup.append("line")
                        .attr("x1", p1.x).attr("y1", p1.y)
                        .attr("x2", p2.x).attr("y2", p2.y)
                        .attr("stroke", "#ffeaa7") // æ·¡é»„è‰²
                        .attr("stroke-width", 1)
                        .attr("stroke-dasharray", "5, 2, 1, 2") // ç‚¹ç”»çº¿æ ·å¼
                        .attr("opacity", 0.6);
                }
            });

            // æ£€æŸ¥åˆå§‹å¼€å…³çŠ¶æ€
            const isLinksVisible = document.getElementById('linkToggle').checked;
            relationsGroup.style("opacity", isLinksVisible ? 1 : 0);

            // 8. ç»˜åˆ¶è¿å‘åœ†å¿ƒçš„çº¿
            svg.selectAll(".link-to-center")
                .data(processedData)
                .enter()
                .append("line")
                .attr("x1", 0).attr("y1", 0)
                .attr("x2", d => d.x).attr("y2", d => d.y)
                .attr("stroke", d => colorScale(d.gender))
                .attr("stroke-width", 1)
                .attr("opacity", 0.3)
                .attr("stroke-dasharray", d => d.contact ? "0" : "3,3");

            // 9. ç»˜åˆ¶åœ†å¿ƒï¼ˆæˆ‘ï¼‰
            svg.append("circle")
                .attr("r", Math.min(width, height) < 600 ? 12 : 16)
                .attr("fill", "#ffd700")
                .style("filter", "url(#glow)");
            
            svg.append("text")
                .attr("y", Math.min(width, height) < 600 ? 28 : 35)
                .attr("text-anchor", "middle")
                .attr("fill", "#ffd700")
                .attr("font-size", "12px")
                .text("æˆ‘");

            // 10. ç»˜åˆ¶æœ‹å‹èŠ‚ç‚¹
            const tooltip = d3.select("#tooltip");

            const nodes = svg.selectAll(".node")
                .data(processedData)
                .enter()
                .append("circle")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("r", d => d.distance < 20 ? (Math.min(width, height) < 600 ? 10 : 14) : (Math.min(width, height) < 600 ? 6 : 9))
                .attr("fill", d => colorScale(d.gender))
                .style("filter", "url(#glow)")
                .style("cursor", "pointer")
                .style("stroke", "white")
                .style("stroke-width", "1.5px")
                .style("stroke-opacity", 0); // é»˜è®¤ä¸æ˜¾ç¤ºæè¾¹

            // 11. äº¤äº’äº‹ä»¶
            nodes.on("mouseover", function(event, d) {
                // é«˜äº®é€‰ä¸­ç‚¹
                d3.select(this)
                    .transition().duration(200)
                    .attr("r", 20)
                    .style("stroke-opacity", 0.8);

                // æ„å»º Tooltip å†…å®¹ (å¤„ç†ç©ºå€¼)
                let htmlContent = `<h3>${d.name}</h3>`;
                
                // æ ‡ç­¾åŒº
                htmlContent += `<div class="tag-container">`;
                htmlContent += `<span class="tag">${d.stage}</span>`;
                if(d.mbti) htmlContent += `<span class="tag mbti">${d.mbti}</span>`;
                if(d.personality) htmlContent += `<span class="tag personality">${d.personality}</span>`;
                htmlContent += `</div>`;

                htmlContent += `<div style="font-size:12px; color:#aaa; margin-bottom:5px;">${d.gender} Â· ${d.contact ? "ä¿æŒè”ç³»" : "æš‚æ— è”ç³»"}</div>`;
                htmlContent += `<p>â€œ${d.story}â€</p>`;

                tooltip.html(htmlContent)
                    .style("opacity", 1);
                
                // ç§»åŠ¨ç«¯ä¸éœ€è¦è·Ÿéšé¼ æ ‡ï¼Œç”±CSSæ§åˆ¶ä½ç½®
                // åªæœ‰éç§»åŠ¨ç«¯æ‰è·Ÿéšé¼ æ ‡
                if (window.innerWidth > 600) {
                     tooltip.style("left", (event.pageX) + "px")
                            .style("top", (event.pageY) + "px");
                }
            })
            .on("mousemove", function(event) {
                 if (window.innerWidth > 600) {
                     tooltip.style("left", (event.pageX) + "px")
                            .style("top", (event.pageY) + "px");
                 }
            })
            .on("mouseout", function(event, d) {
                // æ¢å¤åŸçŠ¶
                const originalR = d.distance < 20 ? (Math.min(width, height) < 600 ? 10 : 14) : (Math.min(width, height) < 600 ? 6 : 9);
                d3.select(this)
                    .transition().duration(200)
                    .attr("r", originalR)
                    .style("stroke-opacity", 0);
                
                tooltip.style("opacity", 0);
            });

            // å…¥åœºåŠ¨ç”»
            nodes.attr("r", 0)
                 .transition()
                 .duration(1000)
                 .attr("r", d => d.distance < 20 ? (Math.min(width, height) < 600 ? 10 : 14) : (Math.min(width, height) < 600 ? 6 : 9));
        }

        // ==========================================
        // ğŸ® åˆå§‹åŒ–ä¸äº‹ä»¶ç›‘å¬
        // ==========================================

        // 1. åˆå§‹åŒ–
        createStars();
        drawChart();

        // 2. ç›‘å¬çª—å£å¤§å°å˜åŒ– (å“åº”å¼é€‚é…)
        let resizeTimer;
        window.addEventListener("resize", () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                createStars(); // é‡åšèƒŒæ™¯
                drawChart();   // é‡ç”»å›¾è¡¨
            }, 200);
        });

        // 3. ç›‘å¬å¼€å…³æ§åˆ¶ (æœ‹å‹é—´è¿çº¿)
        document.getElementById('linkToggle').addEventListener('change', function(e) {
            const relationGroup = d3.select("#relation-lines");
            if(e.target.checked) {
                relationGroup.transition().duration(500).style("opacity", 1);
            } else {
                relationGroup.transition().duration(500).style("opacity", 0);
            }
        });

    </script>
</body>
</html>
