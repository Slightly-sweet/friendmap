<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„æ˜Ÿç³»å¼•åŠ›å›¾ Pro</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            background-color: #0b0c10;
            font-family: 'PingFang SC', sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            color: white;
            position: relative;
        }

        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch-label {
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
        }
        
        input[type="checkbox"] {
            margin-right: 8px;
            accent-color: #66fcf1;
            cursor: pointer;
        }

        /* æ‚¬æµ®æç¤ºæ¡† (è‡ªåŠ¨é€‚é…å†…å®¹é«˜åº¦) */
        #tooltip {
            position: absolute;
            opacity: 0;
            background: rgba(16, 20, 30, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(102, 252, 241, 0.3);
            padding: 15px;
            border-radius: 8px;
            pointer-events: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            max-width: 260px;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 20;
            transform: translate(-50%, -110%);
        }

        #tooltip h3 { margin: 0 0 5px 0; font-size: 16px; color: #66fcf1; }
        #tooltip .tags { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
        #tooltip .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); color: #ccc; }
        #tooltip p { margin: 5px 0 0 0; font-size: 12px; line-height: 1.5; color: #fff; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px; }

        /* è¿çº¿æ–‡å­—èƒŒæ™¯ï¼Œé˜²æ­¢å¤ªä¹±çœ‹ä¸æ¸… */
        .link-label-bg {
            fill: #0b0c10;
            opacity: 0.8;
        }
    </style>
</head>
<body>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="controls">
        <label class="switch-label">
            <input type="checkbox" id="toggleLinks" checked>
            æ˜¾ç¤ºæœ‹å‹é—´å…³ç³»
        </label>
    </div>

    <div id="tooltip"></div>

    <script>
        // ==========================================
        // ğŸ‘‡ é…ç½®åŒºåŸŸï¼šè¯·åœ¨è¿™é‡Œå¡«å…¥ä½ çš„æ•°æ® ğŸ‘‡
        // ==========================================

        // 1. é˜¶æ®µæ’åºï¼ˆä½ å¯ä»¥éšæ„å¢åŠ ã€å‡å°‘ã€æ”¹åï¼Œé¡ºåºå†³å®šäº†æ‰‡åŒºçš„ä½ç½®ï¼‰
        // åªæœ‰è¿™é‡Œå‡ºç°çš„é˜¶æ®µï¼Œæ‰ä¼šåœ¨å›¾ä¸Šæ˜¾ç¤ºã€‚
        const stageOrder = ["å°å­¦", "åˆä¸­", "é«˜ä¸­", "å¤§å­¦", "ç ”ç©¶ç”Ÿ", "å®ä¹ ", "ç¤¾å›¢", "ç½‘å‹"];

        // 2. æœ‹å‹æ•°æ® (Nodes)
        // å¿…å¡«ï¼šid (å”¯ä¸€æ ‡è¯†), name, stage, distance (0-100), gender
        // é€‰å¡«ï¼šmbti, personality, story, contact (é»˜è®¤true)
        const friendsData = [
            { id: "a1", name: "Aå›", stage: "ç ”ç©¶ç”Ÿ", distance: 15, gender: "å¥³", mbti: "ENFP", personality: "å¿«ä¹å°ç‹—", story: "ä¹Ÿæ˜¯æˆ‘ä»¬friend mapè®¡åˆ’çš„æ‰§è¡Œäººï¼" },
            { id: "b1", name: "Bå¸ˆå…„", stage: "ç ”ç©¶ç”Ÿ", distance: 40, gender: "ç”·", mbti: "INTJ", personality: null, story: "å¸¦æˆ‘åšç§‘ç ”çš„å¤§ç¥" }, // personality ä¸ºç©ºä¹Ÿæ²¡äº‹
            { id: "c1", name: "CåŒå­¦", stage: "å¤§å­¦", distance: 20, gender: "å¥³", story: "æœ¬ç§‘å®¤å‹ï¼Œä¸€èµ·é€ƒè¿‡è¯¾" },
            { id: "d1", name: "DåŒæ¡Œ", stage: "é«˜ä¸­", distance: 30, gender: "å¥³", mbti: "ISFJ", story: "é«˜ä¸­ä¸‰å¹´åŒæ¡Œ" },
            { id: "e1", name: "Eè€ç­", stage: "é«˜ä¸­", distance: 80, gender: "ç”·", contact: false, story: "å¾ˆä¸¥å‰ä½†è´Ÿè´£çš„è€å¸ˆ" },
            { id: "f1", name: "Fç½‘å‹", stage: "ç½‘å‹", distance: 50, gender: "ç”·", story: "æ‰“æ¸¸æˆè®¤è¯†çš„" },
            { id: "g1", name: "GåŒäº‹", stage: "å®ä¹ ", distance: 45, gender: "å¥³", story: "æ•™æˆ‘Excel" },
            // ä¸ºäº†æµ‹è¯•é‡å ï¼Œæ•…æ„åŠ å‡ ä¸ªè·ç¦»ç›¸ä¼¼çš„
            { id: "x1", name: "Xå›", stage: "ç ”ç©¶ç”Ÿ", distance: 15, gender: "å¥³", story: "æµ‹è¯•é‡å 1" },
            { id: "x2", name: "Yå›", stage: "ç ”ç©¶ç”Ÿ", distance: 15, gender: "å¥³", story: "æµ‹è¯•é‡å 2" },
        ];

        // 3. æœ‹å‹é—´çš„å…³ç³» (Links)
        // source: èµ·å§‹äººid, target: ç›®æ ‡äººid, label: å…³ç³»å
        // type: "arrow" (å¸¦ç®­å¤´å•å‘), "dashed" (è™šçº¿æ— æ–¹å‘), "solid" (å®çº¿æ— æ–¹å‘)
        const interLinksData = [
            { source: "a1", target: "b1", label: "å¸ˆå…„å¦¹", type: "arrow" },
            { source: "c1", target: "d1", label: "ç«Ÿç„¶è®¤è¯†", type: "dashed" },
            { source: "x1", target: "x2", label: "åŒèƒèƒ", type: "solid" }
        ];

        // ==========================================
        // ğŸ‘† é…ç½®ç»“æŸï¼Œä¸‹æ–¹ä»£ç è´Ÿè´£è‡ªåŠ¨è®¡ç®—å’Œç»˜å›¾ ğŸ‘†
        // ==========================================

        const container = d3.select("body");
        let svg, width, height, centerX, centerY, maxRadius;

        // åˆå§‹åŒ– SVG
        function initSVG() {
            container.select("svg").remove();
            width = window.innerWidth;
            height = window.innerHeight;
            centerX = width / 2;
            centerY = height / 2;
            // é€‚é…æ‰‹æœºï¼šå¦‚æœå±å¹•çª„ï¼ŒåŠå¾„å°±å°ä¸€ç‚¹
            maxRadius = Math.min(width, height) / 2 - (width < 600 ? 40 : 100);

            svg = container.append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .append("g")
                .attr("transform", `translate(${centerX},${centerY})`);

            drawGraph();
        }

        function drawGraph() {
            // --- 1. è®¡ç®—åŠ¨æ€æ‰‡åŒºè§’åº¦ ---
            // ç»Ÿè®¡æ¯ä¸ªé˜¶æ®µçš„äººæ•°
            const stageCounts = {};
            stageOrder.forEach(s => stageCounts[s] = 0);
            friendsData.forEach(d => {
                if(stageCounts.hasOwnProperty(d.stage)) stageCounts[d.stage]++;
            });

            const totalNodes = friendsData.length;
            // è‡³å°‘ç»™æ¯ä¸ªæ‰‡åŒºä¿ç•™ä¸€ä¸ªæœ€å°è§’åº¦ï¼Œé˜²æ­¢å¤ªçª„
            const minAnglePerStage = Math.PI / 6; // 30åº¦
            let currentAngle = 0;
            const stageAngles = {};

            // åŠ¨æ€åˆ†é…è§’åº¦ç®—æ³•
            stageOrder.forEach(stage => {
                const count = stageCounts[stage];
                // åŸºç¡€æƒé‡ + äººæ•°æƒé‡
                let weight = (count / Math.max(1, totalNodes)) * (Math.PI * 2);
                // ä¿è¯æœ€å°å®½åº¦
                if (weight < minAnglePerStage && count > 0) weight = minAnglePerStage;
                if (count === 0) weight = minAnglePerStage / 2; //å³ä½¿æ²¡äººä¹Ÿç•™ä¸€ç‚¹ç‚¹ç©ºä½å±•ç¤ºæ ‡ç­¾

                stageAngles[stage] = {
                    start: currentAngle,
                    end: currentAngle + weight,
                    middle: currentAngle + weight / 2
                };
                currentAngle += weight;
            });

            // å¦‚æœæ€»è§’åº¦è¶…è¿‡2PIï¼Œéœ€è¦å‹ç¼©ï¼ˆè™½ç„¶é€»è¾‘ä¸Šä¼šè‡ªåŠ¨é€‚é…ï¼Œä½†ä¸ºäº†ä¸¥è°¨ï¼‰
            const totalCalcAngle = currentAngle;
            const scaleFactor = (Math.PI * 2) / totalCalcAngle;
            
            // é‡æ–°ä¿®æ­£è§’åº¦
            let runningAngle = 0;
            stageOrder.forEach(stage => {
                const oldStart = stageAngles[stage].start;
                const oldEnd = stageAngles[stage].end;
                const span = (oldEnd - oldStart) * scaleFactor;
                stageAngles[stage].start = runningAngle;
                stageAngles[stage].end = runningAngle + span;
                stageAngles[stage].middle = runningAngle + span / 2;
                runningAngle += span;
            });


            // --- 2. ç»˜åˆ¶æ‰‡åŒºèƒŒæ™¯å’Œæ ‡ç­¾ ---
            const radiusScale = d3.scaleLinear().domain([0, 100]).range([40, maxRadius]);
            
            stageOrder.forEach(stage => {
                const angles = stageAngles[stage];
                
                // ç»˜åˆ¶åˆ†éš”çº¿
                const lineX = Math.sin(angles.start) * maxRadius;
                const lineY = -Math.cos(angles.start) * maxRadius;
                
                svg.append("line")
                    .attr("x1", 0).attr("y1", 0)
                    .attr("x2", lineX).attr("y2", lineY)
                    .attr("stroke", "rgba(255,255,255,0.05)")
                    .attr("stroke-dasharray", "4,4");

                // ç»˜åˆ¶æ ‡ç­¾
                const labelRadius = maxRadius + 20;
                const labelX = Math.sin(angles.middle) * labelRadius;
                const labelY = -Math.cos(angles.middle) * labelRadius;
                
                // æ ‡ç­¾æ—‹è½¬é€»è¾‘ï¼ˆé˜²æ­¢æ–‡å­—å€’ç€ï¼‰
                let rotation = (angles.middle * 180 / Math.PI);
                if (rotation > 180) rotation -= 360; 
                
                svg.append("text")
                    .attr("x", labelX)
                    .attr("y", labelY)
                    .attr("text-anchor", "middle")
                    .attr("dominant-baseline", "middle")
                    .attr("fill", "#666")
                    .attr("font-size", width < 600 ? "10px" : "12px")
                    .text(stage);
            });


            // --- 3. ç‰©ç†å¼•æ“ï¼šè®¡ç®—èŠ‚ç‚¹ä½ç½®å¹¶é˜²é‡å  ---
            
            // é¢„è®¡ç®—ç†æƒ³ä½ç½®
            friendsData.forEach(d => {
                const angles = stageAngles[d.stage];
                if(!angles) return; // é˜²æ­¢æ•°æ®é‡Œçš„é˜¶æ®µä¸åœ¨é…ç½®è¡¨ä¸­
                
                // åˆå§‹ç»™ä¸€ä¸ªéšæœºåç§»ï¼Œé¿å…æ‰€æœ‰äººéƒ½åœ¨æ­£ä¸­é—´
                const randomSpread = (angles.end - angles.start) * 0.6;
                const angle = angles.start + (angles.end - angles.start) * 0.2 + Math.random() * randomSpread;
                const r = radiusScale(d.distance);

                // è®°å½•â€œç†æƒ³ç›®æ ‡ç‚¹â€
                d.targetX = Math.sin(angle) * r;
                d.targetY = -Math.cos(angle) * r;
                d.x = d.targetX; // åˆå§‹ä½ç½®
                d.y = d.targetY;
                d.r = d.distance < 20 ? 12 :
