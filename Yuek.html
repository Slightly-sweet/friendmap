<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yuek's Friend Map V4.0 (High-Res)</title>
    <!-- å¼•å…¥ D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            background-color: #050608; /* æ›´çº¯å‡€çš„æ·±é»‘èƒŒæ™¯ */
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            -webkit-tap-highlight-color: transparent;
        }

        /* æ¸²æŸ“ä¼˜åŒ–ï¼šæŠ—é”¯é½¿ */
        svg {
            shape-rendering: geometricPrecision;
            text-rendering: geometricPrecision;
        }

        /* æ‚¬åœå¡ç‰‡ (æ™ºèƒ½å®šä½) */
        #tooltip {
            position: fixed;
            opacity: 0;
            background: rgba(10, 15, 25, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(102, 252, 241, 0.5);
            padding: 15px;
            border-radius: 8px;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.9);
            width: 240px;
            z-index: 1000;
            transition: opacity 0.15s ease;
            font-size: 13px;
        }
        #tooltip h3 { margin: 0 0 5px 0; color: #66fcf1; font-size: 1.1em; letter-spacing: 1px; }
        #tooltip .tags { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        #tooltip .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.15); color: #fff; }
        #tooltip p { margin: 0; line-height: 1.6; color: #ddd; }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: 30px;
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        .switch { position: relative; display: inline-block; width: 36px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #66fcf1; }
        input:checked + .slider:before { transform: translateX(18px); }

        /* æ˜Ÿæ˜ŸèƒŒæ™¯ä¼˜åŒ–ï¼šæ›´äº®ã€æ›´å¤§ */
        .star { 
            position: absolute; 
            background: white; 
            border-radius: 50%; 
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.8); /* å‘å…‰æ•ˆæœ */
            animation: twinkle 4s infinite ease-in-out; 
        }
        @keyframes twinkle { 
            0%, 100% { opacity: 0.3; transform: scale(0.8); } 
            50% { opacity: 1; transform: scale(1.2); } 
        }

        /* åœˆå­æ ‡ç­¾ */
        .group-label {
            font-size: 11px;
            fill: #66fcf1;
            font-weight: bold;
            text-shadow: 0 0 3px #000, 0 0 5px #000; /* æè¾¹é˜²æ­¢çœ‹ä¸æ¸… */
            pointer-events: none;
            opacity: 0.8;
        }
    </style>
</head>
<body>

    <div id="tooltip"></div>

    <div class="controls">
        <span>æ˜¾ç¤ºåœˆå­ & è¿çº¿</span>
        <label class="switch">
            <input type="checkbox" id="toggleRelations" checked>
            <span class="slider"></span>
        </label>
    </div>

    <script>
        // ==========================================
        // ğŸ› ï¸ æ•°æ®é…ç½®åŒºåŸŸ
        // ==========================================

        const customOrder = ["åˆä¸­", "é«˜ä¸­", "æœ¬ç§‘", "ç¡•å£«", "å®ä¹ "];

        const friendsData = [
            // --- åˆä¸­ ---
            { id: "M01", name: "ä¸¸è€å¸ˆ/è ¢æ»¢", stage: "åˆä¸­", distance: 6, contact: true, gender: "å¥³", mbti: "INFJ", personality: "æ·¡æ·¡çš„ç»¿è€å¤´", story: "æ·¡æ·¡çš„ç»¿è€å¤´ã€‚" },
            { id: "M02", name: "ç‹—å­/å°å­”è€å¸ˆ", stage: "åˆä¸­", distance: 6, contact: true, gender: "ç”·", mbti: "ISFJ", personality: "é“å¾·æ ‡å…µ", story: "è€å®äººä¸€æšã€‚" },
            { id: "M03", name: "xx/å‰å‰", stage: "åˆä¸­", distance: 51, contact: false, gender: "ç”·", mbti: "ISFP", personality: "", story: "2019ä¹‹åå°±æ²¡è§è¿‡é¢æƒ¹ï¼Œç›®å‰ä»…æœ‹å‹åœˆç‚¹èµä¹‹äº¤ã€‚" },
        
            // --- é«˜ä¸­ ---
            { id: "H01", name: "kiki", stage: "é«˜ä¸­", distance: 11, contact: true, gender: "å¥³", mbti: "ISTJ", personality: "äº’è”ç½‘HR", story: "ä¸€èµ·å†™æ¯•ä¸šè®ºæ–‡è”ç›Ÿã€‚å”¯ä¸€ä¼šæ‰“è¯­éŸ³èŠçƒ¦æ¼çš„æœ‹å‹ã€‚" },
            { id: "H02", name: "ruojia", stage: "é«˜ä¸­", distance: 16, contact: true, gender: "å¥³", mbti: "INFP", personality: "äºŒæ¬¡å…ƒ", story: "å…±åŒçˆ±å¥½æœ€å¤šçš„æœ‹å‹ï¼ˆè€½ç¾/ä¹™æ¸¸ï¼‰ã€‚" },
            { id: "H03", name: "dudu", stage: "é«˜ä¸­", distance: 21, contact: true, gender: "å¥³", mbti: "", personality: "ç†ç§‘ç™½ç—´", story: "é«˜ä¸‰åŒæ¡Œï¼Œäº’ç›¸é¼“åŠ±çš„é©å‘½å‹è°Šã€‚" },
            { id: "H04", name: "fanfan", stage: "é«˜ä¸­", distance: 26, contact: true, gender: "å¥³", mbti: "ENFJ", personality: "", story: "ç°åœ¨åœ¨ç¾å›½å·¥ä½œï¼Œåœ£è¯èŠ‚å›å¹¿å·è§çš„æœ‹å‹ã€‚" },
            { id: "H05", name: "å¤§å˜´å¥/å¸ˆå‚…", stage: "é«˜ä¸­", distance: 91, contact: false, gender: "ç”·", mbti: "ENFP", personality: "ç‹æœ‹ç‹—å‹", story: "ç°åœ¨ä»…æœ‹å‹åœˆç‚¹èµè¯„è®ºä¹‹äº¤ï¼Œ0ç§èŠã€‚" },
        
            // --- æœ¬ç§‘ ---
            { id: "U01", name: "è¾£å­", stage: "æœ¬ç§‘", distance: 13, contact: true, gender: "å¥³", mbti: "INFJ", personality: "æ··å­ç»„", story: "ç»å¸¸ç†¬å¤œçš„å¹¿å‘Šäººã€‚å†°æ²™äº‹ä»¶ä¸»äººå…¬ã€‚" },
            { id: "U02", name: "çƒçƒ", stage: "æœ¬ç§‘", distance: 21, contact: true, gender: "å¥³", mbti: "INFJ", personality: "æ··å­ç»„", story: "å†°æ²™äº‹ä»¶å«Œç–‘äººï¼šâ€œæ˜¯æ²¡ç»™é’±å—â€ã€‚" },
            { id: "U03", name: "å¦®", stage: "æœ¬ç§‘", distance: 28, contact: true, gender: "å¥³", mbti: "", personality: "å®¤å‹", story: "å…³ç³»æœ€å¥½çš„å®¤å‹ã€‚" },
            { id: "U04", name: "éŸµå§", stage: "æœ¬ç§‘", distance: 28, contact: true, gender: "å¥³", mbti: "", personality: "å®¤å‹", story: "é™ªæˆ‘å»æ€¥è¯Šçš„å®¤å‹ã€‚" },
            { id: "U05", name: "ç¾Š", stage: "æœ¬ç§‘", distance: 29, contact: true, gender: "å¥³", mbti: "", personality: "å®¤å‹", story: "äº§å“åŒè¡Œï¼Œæˆ‘çš„å…¥è¡Œå¯è’™ã€‚" },
            { id: "U06", name: "é¥¼é¥¼", stage: "æœ¬ç§‘", distance: 41, contact: true, gender: "å¥³", mbti: "INFP", personality: "æ··å­ç»„", story: "å†°æ²™äº‹ä»¶å«Œç–‘äººï¼šâ€œæ˜¯æˆ‘çš„å—ï¼Œå–ä¸€å£â€ã€‚" },
        
            // --- ç¡•å£« ---
            { id: "G01", name: "é¸­è€å¸ˆ", stage: "ç¡•å£«", distance: 29, contact: true, gender: "å¥³", mbti: "ENFP", personality: "è¿½æ˜Ÿæ­å­", story: "ä¼šä¸€èµ·å–é…’çš„æœ‹å‹ã€‚åŒæ‹…ã€‚" },
            { id: "G02", name: "å°æ—è€å¸ˆ", stage: "ç¡•å£«", distance: 31, contact: true, gender: "å¥³", mbti: "INTJ", personality: "å®¤å‹", story: "äº§å“æ¢å­ã€‚" },
            { id: "G03", name: "å°åˆ˜", stage: "ç¡•å£«", distance: 36, contact: true, gender: "å¥³", mbti: "INFJ", personality: "ç ”å‹", story: "ä¸€èµ·å¤‡è€ƒå¤è¯•çš„å­¦ç¡•åŒå­¦ã€‚" },
        
            // --- å®ä¹  ---
            { id: "I01", name: "æ‰æ‰", stage: "å®ä¹ ", distance: 11, contact: true, gender: "å¥³", mbti: "ENFP", personality: "bilibili", story: "è¯»ç ”åå…³ç³»æœ€äº²å¯†çš„æœ‹å‹ã€‚æˆ‘çš„æ”¾ä¸‹æ˜¯ç”±å¥¹å¼•è·¯çš„ã€‚" },
            { id: "I02", name: "æŸ³ä¸å“¥", stage: "å®ä¹ ", distance: 23, contact: true, gender: "ç”·", mbti: "ISFJ", personality: "bilibili", story: "ç«æ˜Ÿæ’åœ°çƒçš„å…³ç³»ã€‚" },
            { id: "I03", name: "qqå°å†°", stage: "å®ä¹ ", distance: 26, contact: true, gender: "å¥³", mbti: "INFJ", personality: "mi", story: "è§‚å¿µä¸ä¸€æ ·ä½†äººå¾ˆå¥½ã€‚" },
        ];

        const groupsData = [
            { members: ["è¾£å­", "çƒçƒ", "é¥¼é¥¼"], label: "å†°æ²™äº‹ä»¶ç»„", type: "dashed" },
            { members: ["å¦®", "éŸµå§", "ç¾Š"], label: "å¤§å­¦å®¤å‹", type: "solid" },
            { members: ["ä¸¸è€å¸ˆ/è ¢æ»¢", "ç‹—å­/å°å­”è€å¸ˆ"], label: "åˆä¸­é“ä¸‰è§’", type: "dotted" }
        ];

        const relationsData = [];

        // ==========================================
        // âš™ï¸ æ ¸å¿ƒé€»è¾‘
        // ==========================================

        function init() {
            d3.select("body").selectAll("svg").remove();

            const width = window.innerWidth;
            const height = window.innerHeight;
            // è°ƒæ•´æœ€å¤§åŠå¾„ï¼Œç•™å‡ºæ›´å¤šè¾¹ç¼˜ç©ºé—´
            const maxRadius = Math.min(width, height) * 0.40; 
            const centerRadius = 24;

            const svg = d3.select("body").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", [ -width / 2, -height / 2, width, height ])
                .style("max-width", "100%")
                .style("height", "auto");

            const mainG = svg.append("g");

            // å®šä¹‰æ»¤é•œ (ä¿®å¤æ­£æ–¹å½¢å…‰æ–‘é—®é¢˜ - æ‰©å¤§filterRegion)
            const defs = svg.append("defs");
            defs.append("marker").attr("id", "arrow").attr("viewBox", "0 -5 10 10").attr("refX", 18).attr("refY", 0).attr("markerWidth", 5).attr("markerHeight", 5).attr("orient", "auto")
                .append("path").attr("d", "M0,-5L10,0L0,5").attr("fill", "#66fcf1");
            
            const filter = defs.append("filter")
                .attr("id", "glow")
                .attr("filterUnits", "userSpaceOnUse") // å…³é”®ä¿®å¤ï¼šé˜²æ­¢è£å‰ª
                .attr("x", "-50%").attr("y", "-50%")
                .attr("width", "200%").attr("height", "200%");
            
            filter.append("feGaussianBlur").attr("stdDeviation", "3").attr("result", "coloredBlur");
            const feMerge = filter.append("feMerge");
            feMerge.append("feMergeNode").attr("in", "coloredBlur");
            feMerge.append("feMergeNode").attr("in", "SourceGraphic");

            // 1. è®¡ç®—æ‰‡åŒº (åŠ¨æ€åˆ†é…)
            const stageCounts = d3.rollups(friendsData, v => v.length, d => d.stage);
            const stageMap = new Map(stageCounts);
            let allStages = Array.from(stageMap.keys());
            allStages.sort((a, b) => {
                let ia = customOrder.indexOf(a); let ib = customOrder.indexOf(b);
                if (ia === -1) ia = 999; if (ib === -1) ib = 999;
                return ia - ib;
            });
            const pie = d3.pie().value(d => stageMap.get(d)).sort(null).padAngle(0.1); // å¢åŠ æ‰‡åŒºç©ºéš™
            const arcs = pie(allStages);
            const angleMap = {};
            arcs.forEach(d => { angleMap[d.data] = { start: d.startAngle, end: d.endAngle, mid: (d.startAngle + d.endAngle) / 2 }; });

            // 2. ç»˜åˆ¶åˆ†åŒºçº¿ (å¢å¼ºå¯è§åº¦)
            const sectorG = mainG.append("g").attr("class", "sectors");
            arcs.forEach(d => {
                const r = maxRadius + 35;
                const midAngle = (d.startAngle + d.endAngle) / 2;
                const labelX = Math.sin(midAngle) * r;
                const labelY = -Math.cos(midAngle) * r;
                const lineX = Math.sin(d.startAngle) * (maxRadius + 10);
                const lineY = -Math.cos(d.startAngle) * (maxRadius + 10);
                
                // åˆ†åŒºçº¿
                sectorG.append("line")
                    .attr("x1", 0).attr("y1", 0).attr("x2", lineX).attr("y2", lineY)
                    .attr("stroke", "rgba(255,255,255,0.25)") // æé«˜é€æ˜åº¦
                    .attr("stroke-width", 1.5) // åŠ ç²—
                    .attr("stroke-dasharray", "5,5"); // æ˜æ˜¾çš„è™šçº¿

                sectorG.append("text").attr("x", labelX).attr("y", labelY).attr("text-anchor", "middle").attr("dominant-baseline", "middle")
                    .attr("fill", "#ccc").attr("font-size", "14px").style("font-weight", "bold").text(d.data);
            });

            // 3. èŠ‚ç‚¹å¸ƒå±€è®¡ç®— (é˜²æ­¢æç«¯å€¼)
            // ä½¿ç”¨ clamp é™åˆ¶æœ€å°å’Œæœ€å¤§èŒƒå›´ï¼Œé˜²æ­¢å¤ªè¿‘æˆ–å¤ªè¿œ
            const radiusScale = d3.scaleLinear()
                .domain([0, 100])
                .range([centerRadius + 40, maxRadius]); // æœ€å°è·ç¦»åŠ å¤§ï¼Œç•™å‡ºä¸­å¿ƒç©ºé—´

            const nodes = friendsData.map(d => {
                const angleInfo = angleMap[d.stage];
                // å¢åŠ æ‰‡åŒºå†…çš„éšæœºè§’åº¦èŒƒå›´ï¼Œè®©ç‚¹æ›´åˆ†æ•£
                const angleSpread = (angleInfo.end - angleInfo.start) * 0.6; 
                const angle = angleInfo.mid + (Math.random() - 0.5) * angleSpread; 
                
                // è·ç¦»å¤„ç†ï¼šå¦‚æœè·ç¦»ç‰¹åˆ«å°ï¼Œå¼ºåˆ¶æ¨å¼€ä¸€ç‚¹ï¼›å¦‚æœç‰¹åˆ«å¤§ï¼Œé™åˆ¶åœ¨è¾¹ç¼˜
                let normalizedDist = d.distance;
                if(d.distance < 10) normalizedDist = 10;
                if(d.distance > 95) normalizedDist = 95;

                const r = radiusScale(normalizedDist);
                const targetX = Math.sin(angle) * r;
                const targetY = -Math.cos(angle) * r;
                
                return { 
                    ...d, 
                    x: targetX, y: targetY, 
                    targetX: targetX, targetY: targetY, 
                    radius: d.distance < 20 ? 15 : 10 // ç¢°æ’åŠå¾„
                };
            });

            // 4. å¼ºåŠ›ç‰©ç†å¼•æ“ (åˆ†æ•£å¸ƒå±€)
            const simulation = d3.forceSimulation(nodes)
                .force("x", d3.forceX(d => d.targetX).strength(0.3)) // é™ä½å½’ä½å¼•åŠ›ï¼Œå…è®¸æ›´å¤šåç§»
                .force("y", d3.forceY(d => d.targetY).strength(0.3))
                .force("collide", d3.forceCollide(d => d.radius + 15).iterations(4).strength(1)) // å¤§å¹…å¢åŠ ç¢°æ’åŠå¾„(radius+15)
                .stop();
            
            // è¿è¡Œæ›´å¤šæ¬¡ä»¥è¾¾åˆ°ç¨³å®šå¹³è¡¡
            for (let i = 0; i < 300; i++) simulation.tick();

            const nameToNode = {};
            nodes.forEach(n => nameToNode[n.name] = n);

            // ==========================================
            // âœ¨ ç»˜åˆ¶åœˆå­ (æ”¹ç”¨è™šçº¿åœˆï¼Œéå¡«å……)
            // ==========================================
            const groupLayer = mainG.append("g").attr("class", "group-layer");
            
            groupsData.forEach((group, i) => {
                const members = group.members.map(name => nameToNode[name]).filter(n => n);
                if (members.length < 2) return;

                let points = members.map(d => [d.x, d.y]);
                let pathData = "";
                let center = [0, 0];

                if (members.length === 2) {
                    pathData = `M${points[0][0]},${points[0][1]} L${points[1][0]},${points[1][1]}`;
                    center = [(points[0][0]+points[1][0])/2, (points[0][1]+points[1][1])/2];
                } else {
                    const hull = d3.polygonHull(points);
                    if (hull) {
                        // ä½¿ç”¨å¹³æ»‘æ›²çº¿ (Catmull-Rom) ä½¿å¤šè¾¹å½¢æ›´åœ†æ¶¦
                        const lineGen = d3.line().curve(d3.curveCatmullRomClosed.alpha(0.5));
                        pathData = lineGen(hull);
                        center = d3.polygonCentroid(hull);
                    }
                }

                if (pathData) {
                    // ç»˜åˆ¶è™šçº¿åœˆ
                    groupLayer.append("path")
                        .attr("d", pathData)
                        .attr("fill", "none") // ä¸å¡«å……ï¼
                        .attr("stroke", i % 2 === 0 ? "#ff4d94" : "#66fcf1") // äº¤æ›¿é¢œè‰²
                        .attr("stroke-width", members.length === 2 ? 26 : 2) // ä¸¤äººæ—¶ä»éœ€å®½çº¿æ¡†ï¼Œå¤šäººç”¨ç»†çº¿
                        .attr("stroke-linecap", "round")
                        .attr("stroke-linejoin", "round")
                        // å¦‚æœæ˜¯ä¸¤äººï¼Œç”¨å¾ˆå®½çš„é€æ˜çº¿åšèƒŒæ™¯ï¼Œä¸Šé¢å åŠ è™šçº¿
                        .attr("stroke-opacity", members.length === 2 ? 0.2 : 0.8) 
                        .attr("stroke-dasharray", members.length === 2 ? "0" : "6,4"); 
                    
                    // å¦‚æœæ˜¯ä¸¤äººç»„ï¼Œå†åŠ ä¸€æ ¹ç»†è™šçº¿è¿æ¥
                    if(members.length === 2) {
                        groupLayer.append("path")
                            .attr("d", pathData)
                            .attr("fill", "none")
                            .attr("stroke", i % 2 === 0 ? "#ff4d94" : "#66fcf1")
                            .attr("stroke-width", 1.5)
                            .attr("stroke-dasharray", "5,3");
                    }

                    // æ ‡ç­¾
                    groupLayer.append("text")
                        .attr("class", "group-label")
                        .attr("x", center[0])
                        .attr("y", center[1])
                        .attr("text-anchor", "middle")
                        .attr("dy", members.length === 2 ? 4 : 4)
                        .text(group.label);
                }
            });

            // 5. ç»˜åˆ¶è¿çº¿
            const relationsG = mainG.append("g").attr("class", "relations-layer");
            const validRelations = relationsData.filter(r => nameToNode[r.source] && nameToNode[r.target]);
            relationsG.selectAll(".rel-link").data(validRelations).enter().append("path")
                .attr("d", d => `M${nameToNode[d.source].x},${nameToNode[d.source].y} L${nameToNode[d.target].x},${nameToNode[d.target].y}`)
                .attr("stroke", "#66fcf1").attr("stroke-width", 1.5).attr("stroke-opacity", 0.6).attr("fill", "none")
                .attr("stroke-dasharray", "4,4")
                .attr("marker-end", d => d.arrow ? "url(#arrow)" : null);

            const linksG = mainG.append("g").attr("class", "center-links");
            linksG.selectAll("line").data(nodes).enter().append("line")
                .attr("x1", 0).attr("y1", 0).attr("x2", d => d.x).attr("y2", d => d.y)
                .attr("stroke", d => d.gender === "å¥³" ? "#ff4d94" : "#00d2ff")
                .attr("stroke-width", 1).attr("opacity", 0.3)
                .attr("stroke-dasharray", d => d.contact ? "0" : "3,3");

            // 6. ç»˜åˆ¶èŠ‚ç‚¹
            const nodesG = mainG.append("g").attr("class", "nodes");
            const circles = nodesG.selectAll("circle").data(nodes).enter().append("circle")
                .attr("r", d => d.distance < 20 ? 12 : 7)
                .attr("cx", d => d.x).attr("cy", d => d.y)
                .attr("fill", d => d.gender === "å¥³" ? "#ff4d94" : "#00d2ff")
                .style("filter", "url(#glow)")
                .attr("stroke", "#fff")
                .attr("stroke-width", d => d.distance < 20 ? 2 : 1.5)
                .attr("stroke-dasharray", d => d.contact ? "0" : "2,2");

            // ç»˜åˆ¶æˆ‘
            const me = mainG.append("g").style("filter", "url(#glow)");
            me.append("circle").attr("r", 18).attr("fill", "#ffd700");
            me.append("text").attr("y", 5).attr("text-anchor", "middle").attr("fill", "#000").style("font-size", "11px").style("font-weight", "bold").text("æˆ‘");

            // 7. äº¤äº’
            const tooltip = d3.select("#tooltip");
            circles.on("click mouseover", function(event, d) {
                event.stopPropagation();
                d3.select(this).transition().attr("r", 16);
                
                let tagsHtml = `<span class="tag">${d.stage}</span>`;
                if(d.mbti) tagsHtml += `<span class="tag">${d.mbti}</span>`;
                if(d.personality) tagsHtml += `<span class="tag">${d.personality}</span>`;
                if(!d.contact) tagsHtml += `<span class="tag" style="border:1px solid #777">å·²æ–­è”</span>`;
                
                tooltip.html(`<h3>${d.name} <span style="font-size:0.7em;color:#fff;opacity:0.6">${d.gender}</span></h3><div class="tags">${tagsHtml}</div><p>â€œ${d.story}â€</p>`);
                
                const tipNode = tooltip.node();
                const tipW = 272; 
                const tipH = tipNode.offsetHeight || 150; 
                const screenW = window.innerWidth;

                let left = event.clientX + 15;
                let top = event.clientY - tipH - 10;

                if (left + tipW > screenW) left = event.clientX - tipW - 15;
                if (top < 0) top = event.clientY + 20;

                tooltip.style("opacity", 1).style("left", left + "px").style("top", top + "px");

            }).on("mouseout", function() {
                d3.select(this).transition().attr("r", d => d.distance < 20 ? 12 : 7);
                tooltip.style("opacity", 0).style("left", "-9999px");
            });
            
            svg.on("click", () => tooltip.style("opacity", 0).style("left", "-9999px"));

            const toggle = document.getElementById('toggleRelations');
            function updateRelations() {
                const opacity = toggle.checked ? 1 : 0;
                relationsG.transition().style("opacity", opacity);
                groupLayer.transition().style("opacity", opacity);
            }
            toggle.addEventListener('change', updateRelations);
            updateRelations();
        }

        // æ˜Ÿæ˜Ÿç”Ÿæˆ (å¢åŠ æ•°é‡ï¼Œå¤§å°ä¸ä¸€)
        function createStars() {
            const count = 200; // å¢åŠ æ˜Ÿæ˜Ÿæ•°é‡
            for(let i=0; i<count; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 2.5 + 0.5; // å¤§å°éšæœº
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.left = Math.random() * 100 + 'vw';
                star.style.top = Math.random() * 100 + 'vh';
                star.style.opacity = Math.random(); // åˆå§‹é€æ˜åº¦éšæœº
                star.style.animationDuration = (Math.random() * 3 + 2) + 's';
                star.style.animationDelay = Math.random() * 5 + 's';
                document.body.appendChild(star);
            }
        }

        createStars();
        init();
        let resizeTimer;
        window.addEventListener('resize', () => { clearTimeout(resizeTimer); resizeTimer = setTimeout(init, 300); });
    </script>
</body>
</html>
